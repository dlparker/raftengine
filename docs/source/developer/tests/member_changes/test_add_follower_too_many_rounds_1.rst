.. _test_add_follower_too_many_rounds_1:

======================================================================
Test test_add_follower_too_many_rounds_1 from file test_member_changes
======================================================================


    Tests that the membership change process will abort the add node process when the new node fails
    to catch up on all log records in 10 rounds of updates. This is accomplished by intercepting
    the append entries responses that indicate that the new node has finished appending the records
    for the current round ov updates and adding new records to the leader's log (and to the other followers)
    so that the leader starts another round. This is done until ten rounds have been completed, at which
    point the leader should abort the add. 
    Timers are disabled, so all timer driven operations such as heartbeats are manually triggered.
    

Section 1: Normal election
==========================




.. collapse:: section 1 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | N-1  | N-1                         | N-1       | N-2  | N-2                         | N-2       | N-3  | N-3                         | N-3       | N-4  | N-4 | N-4   |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | Role | Op                          | Delta     | Role | Op                          | Delta     | Role | Op                          | Delta     | Role | Op  | Delta |
   +======+=============================+===========+======+=============================+===========+======+=============================+===========+======+=====+=======+
   | CNDI | NEW ROLE                    |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | CNDI | poll+N-2 t-1 li-0 lt-1      |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | CNDI | poll+N-3 t-1 li-0 lt-1      |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | CNDI |                             |           | FLWR | N-1+poll t-1 li-0 lt-1      | t-1       | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | CNDI |                             |           | FLWR | vote+N-1 yes-True           |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | CNDI |                             |           | FLWR |                             |           | FLWR | N-1+poll t-1 li-0 lt-1      | t-1       |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | CNDI |                             |           | FLWR |                             |           | FLWR | vote+N-1 yes-True           |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | N-2+vote yes-True           | lt-1 li-1 | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | NEW ROLE                    |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | ae+N-2 t-1 i-0 lt-0 e-1 c-0 |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | ae+N-3 t-1 i-0 lt-0 e-1 c-0 |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | N-3+vote yes-True           |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD |                             |           | FLWR | N-1+ae t-1 i-0 lt-0 e-1 c-0 | lt-1 li-1 | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD |                             |           | FLWR | N-2+ae_reply ok-True mi-1   |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD |                             |           | FLWR |                             |           | FLWR | N-1+ae t-1 i-0 lt-0 e-1 c-0 | lt-1 li-1 |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD |                             |           | FLWR |                             |           | FLWR | N-3+ae_reply ok-True mi-1   |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | N-2+ae_reply ok-True mi-1   | ci-1      | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | N-3+ae_reply ok-True mi-1   |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_member_changes/test_add_follower_too_many_rounds_1_1.puml
          :scale: 100%


Section 2: Node 1 is leader, inserting some records via direct acceess to logs
==============================================================================




.. collapse:: section 2 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----------------------------+-------+------+-----+-------+------+-----+-------+------+-----------------------------+----------------+
   | N-1  | N-1                         | N-1   | N-2  | N-2 | N-2   | N-3  | N-3 | N-3   | N-4  | N-4                         | N-4            |
   +------+-----------------------------+-------+------+-----+-------+------+-----+-------+------+-----------------------------+----------------+
   | Role | Op                          | Delta | Role | Op  | Delta | Role | Op  | Delta | Role | Op                          | Delta          |
   +======+=============================+=======+======+=====+=======+======+=====+=======+======+=============================+================+
   | LEAD |                             |       | FLWR |     |       | FLWR |     |       | FLWR | m_c+N-1 op-ADD n-mcpy://4   |                |
   +------+-----------------------------+-------+------+-----+-------+------+-----+-------+------+-----------------------------+----------------+
   | LEAD | N-4+m_c op-ADD n-mcpy://4   |       | FLWR |     |       | FLWR |     |       | FLWR |                             |                |
   +------+-----------------------------+-------+------+-----+-------+------+-----+-------+------+-----------------------------+----------------+
   | LEAD | ae+N-4 t-1 i-7 lt-1 e-0 c-7 |       | FLWR |     |       | FLWR |     |       | FLWR |                             |                |
   +------+-----------------------------+-------+------+-----+-------+------+-----+-------+------+-----------------------------+----------------+
   | LEAD |                             |       | FLWR |     |       | FLWR |     |       | FLWR | N-1+ae t-1 i-7 lt-1 e-0 c-7 | t-1            |
   +------+-----------------------------+-------+------+-----+-------+------+-----+-------+------+-----------------------------+----------------+
   | LEAD | N-4+ae_reply ok-False mi-0  |       | FLWR |     |       | FLWR |     |       | FLWR |                             |                |
   +------+-----------------------------+-------+------+-----+-------+------+-----+-------+------+-----------------------------+----------------+
   | LEAD | ae+N-4 t-1 i-0 lt-0 e-1 c-7 |       | FLWR |     |       | FLWR |     |       | FLWR |                             |                |
   +------+-----------------------------+-------+------+-----+-------+------+-----+-------+------+-----------------------------+----------------+
   | LEAD |                             |       | FLWR |     |       | FLWR |     |       | FLWR | N-1+ae t-1 i-0 lt-0 e-1 c-7 | lt-1 li-1 ci-1 |
   +------+-----------------------------+-------+------+-----+-------+------+-----+-------+------+-----------------------------+----------------+
   | LEAD |                             |       | FLWR |     |       | FLWR |     |       | FLWR | N-4+ae_reply ok-True mi-1   |                |
   +------+-----------------------------+-------+------+-----+-------+------+-----+-------+------+-----------------------------+----------------+
   | LEAD | N-4+ae_reply ok-True mi-1   |       | FLWR |     |       | FLWR |     |       | FLWR |                             |                |
   +------+-----------------------------+-------+------+-----+-------+------+-----+-------+------+-----------------------------+----------------+
   | LEAD | ae+N-4 t-1 i-1 lt-1 e-6 c-7 |       | FLWR |     |       | FLWR |     |       | FLWR |                             |                |
   +------+-----------------------------+-------+------+-----+-------+------+-----+-------+------+-----------------------------+----------------+
   | LEAD |                             |       | FLWR |     |       | FLWR |     |       | FLWR | N-1+ae t-1 i-1 lt-1 e-6 c-7 | li-7 ci-7      |
   +------+-----------------------------+-------+------+-----+-------+------+-----+-------+------+-----------------------------+----------------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_member_changes/test_add_follower_too_many_rounds_1_2.puml
          :scale: 100%


Section 3: Starting a loop of round update and inserted new rounds
==================================================================




.. collapse:: section 3 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | N-1  | N-1                                 | N-1         | N-2  | N-2 | N-2   | N-3  | N-3 | N-3   | N-4  | N-4                                 | N-4         |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | Role | Op                                  | Delta       | Role | Op  | Delta | Role | Op  | Delta | Role | Op                                  | Delta       |
   +======+=====================================+=============+======+=====+=======+======+=====+=======+======+=====================================+=============+
   | LEAD |                                     |             | FLWR |     |       | FLWR |     |       | FLWR | N-4+ae_reply ok-True mi-7           |             |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD | N-4+ae_reply ok-True mi-7           |             | FLWR |     |       | FLWR |     |       | FLWR |                                     |             |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD | ae+N-4 t-1 i-7 lt-1 e-1 c-8         |             | FLWR |     |       | FLWR |     |       | FLWR |                                     |             |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD |                                     |             | FLWR |     |       | FLWR |     |       | FLWR | N-1+ae t-1 i-7 lt-1 e-1 c-8         | li-8 ci-8   |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD |                                     | li-9 ci-9   | FLWR |     |       | FLWR |     |       | FLWR | N-4+ae_reply ok-True mi-8           |             |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD | N-4+ae_reply ok-True mi-8           |             | FLWR |     |       | FLWR |     |       | FLWR |                                     |             |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD | ae+N-4 t-1 i-8 lt-1 e-1 c-9         |             | FLWR |     |       | FLWR |     |       | FLWR |                                     |             |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD |                                     |             | FLWR |     |       | FLWR |     |       | FLWR | N-1+ae t-1 i-8 lt-1 e-1 c-9         | li-9 ci-9   |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD |                                     | li-10 ci-10 | FLWR |     |       | FLWR |     |       | FLWR | N-4+ae_reply ok-True mi-9           |             |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD | N-4+ae_reply ok-True mi-9           |             | FLWR |     |       | FLWR |     |       | FLWR |                                     |             |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD | ae+N-4 t-1 i-9 lt-1 e-1 c-10        |             | FLWR |     |       | FLWR |     |       | FLWR |                                     |             |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD |                                     |             | FLWR |     |       | FLWR |     |       | FLWR | N-1+ae t-1 i-9 lt-1 e-1 c-10        | li-10 ci-10 |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD |                                     | li-11 ci-11 | FLWR |     |       | FLWR |     |       | FLWR | N-4+ae_reply ok-True mi-10          |             |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD | N-4+ae_reply ok-True mi-10          |             | FLWR |     |       | FLWR |     |       | FLWR |                                     |             |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD | ae+N-4 t-1 i-10 lt-1 e-1 c-11       |             | FLWR |     |       | FLWR |     |       | FLWR |                                     |             |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD |                                     |             | FLWR |     |       | FLWR |     |       | FLWR | N-1+ae t-1 i-10 lt-1 e-1 c-11       | li-11 ci-11 |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD |                                     | li-12 ci-12 | FLWR |     |       | FLWR |     |       | FLWR | N-4+ae_reply ok-True mi-11          |             |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD | N-4+ae_reply ok-True mi-11          |             | FLWR |     |       | FLWR |     |       | FLWR |                                     |             |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD | ae+N-4 t-1 i-11 lt-1 e-1 c-12       |             | FLWR |     |       | FLWR |     |       | FLWR |                                     |             |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD |                                     |             | FLWR |     |       | FLWR |     |       | FLWR | N-1+ae t-1 i-11 lt-1 e-1 c-12       | li-12 ci-12 |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD |                                     | li-13 ci-13 | FLWR |     |       | FLWR |     |       | FLWR | N-4+ae_reply ok-True mi-12          |             |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD | N-4+ae_reply ok-True mi-12          |             | FLWR |     |       | FLWR |     |       | FLWR |                                     |             |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD | ae+N-4 t-1 i-12 lt-1 e-1 c-13       |             | FLWR |     |       | FLWR |     |       | FLWR |                                     |             |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD |                                     |             | FLWR |     |       | FLWR |     |       | FLWR | N-1+ae t-1 i-12 lt-1 e-1 c-13       | li-13 ci-13 |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD |                                     | li-14 ci-14 | FLWR |     |       | FLWR |     |       | FLWR | N-4+ae_reply ok-True mi-13          |             |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD | N-4+ae_reply ok-True mi-13          |             | FLWR |     |       | FLWR |     |       | FLWR |                                     |             |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD | ae+N-4 t-1 i-13 lt-1 e-1 c-14       |             | FLWR |     |       | FLWR |     |       | FLWR |                                     |             |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD |                                     |             | FLWR |     |       | FLWR |     |       | FLWR | N-1+ae t-1 i-13 lt-1 e-1 c-14       | li-14 ci-14 |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD |                                     | li-15 ci-15 | FLWR |     |       | FLWR |     |       | FLWR | N-4+ae_reply ok-True mi-14          |             |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD | N-4+ae_reply ok-True mi-14          |             | FLWR |     |       | FLWR |     |       | FLWR |                                     |             |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD | ae+N-4 t-1 i-14 lt-1 e-1 c-15       |             | FLWR |     |       | FLWR |     |       | FLWR |                                     |             |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD |                                     |             | FLWR |     |       | FLWR |     |       | FLWR | N-1+ae t-1 i-14 lt-1 e-1 c-15       | li-15 ci-15 |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD |                                     | li-16 ci-16 | FLWR |     |       | FLWR |     |       | FLWR | N-4+ae_reply ok-True mi-15          |             |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD | N-4+ae_reply ok-True mi-15          |             | FLWR |     |       | FLWR |     |       | FLWR |                                     |             |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD | ae+N-4 t-1 i-15 lt-1 e-1 c-16       |             | FLWR |     |       | FLWR |     |       | FLWR |                                     |             |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD |                                     |             | FLWR |     |       | FLWR |     |       | FLWR | N-1+ae t-1 i-15 lt-1 e-1 c-16       | li-16 ci-16 |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD |                                     | li-17 ci-17 | FLWR |     |       | FLWR |     |       | FLWR | N-4+ae_reply ok-True mi-16          |             |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD | N-4+ae_reply ok-True mi-16          |             | FLWR |     |       | FLWR |     |       | FLWR |                                     |             |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD | m_cr+N-4 op-ADD n-mcpy://4 ok-False |             | FLWR |     |       | FLWR |     |       | FLWR |                                     |             |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+
   | LEAD |                                     |             | FLWR |     |       | FLWR |     |       | FLWR | N-1+m_cr op-ADD n-mcpy://4 ok-False |             |
   +------+-------------------------------------+-------------+------+-----+-------+------+-----+-------+------+-------------------------------------+-------------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_member_changes/test_add_follower_too_many_rounds_1_3.puml
          :scale: 100%


