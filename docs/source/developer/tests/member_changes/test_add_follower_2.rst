.. _test_add_follower_2:

======================================================
Test test_add_follower_2 from file test_member_changes
======================================================


    Adding a follower to the cluster with a long log, filled with a bunch entries. We are
    cheating by directly adding the entries to each member node before the add, just to keep the
    logging, time and tracing down.
    Timers are disabled, so all timer driven operations such as heartbeats are manually triggered.
    

Section 1: Normal election
==========================




.. collapse:: section 1 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | N-1  | N-1                         | N-1       | N-2  | N-2                         | N-2       | N-3  | N-3                         | N-3       | N-4  | N-4 | N-4   |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | Role | Op                          | Delta     | Role | Op                          | Delta     | Role | Op                          | Delta     | Role | Op  | Delta |
   +======+=============================+===========+======+=============================+===========+======+=============================+===========+======+=====+=======+
   | CNDI | NEW ROLE                    |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | CNDI | poll+N-2 t-1 li-0 lt-1      |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | CNDI | poll+N-3 t-1 li-0 lt-1      |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | CNDI |                             |           | FLWR | N-1+poll t-1 li-0 lt-1      | t-1       | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | CNDI |                             |           | FLWR | vote+N-1 yes-True           |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | CNDI |                             |           | FLWR |                             |           | FLWR | N-1+poll t-1 li-0 lt-1      | t-1       |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | CNDI |                             |           | FLWR |                             |           | FLWR | vote+N-1 yes-True           |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | N-2+vote yes-True           | lt-1 li-1 | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | NEW ROLE                    |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | ae+N-2 t-1 i-0 lt-0 e-1 c-0 |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | ae+N-3 t-1 i-0 lt-0 e-1 c-0 |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | N-3+vote yes-True           |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD |                             |           | FLWR | N-1+ae t-1 i-0 lt-0 e-1 c-0 | lt-1 li-1 | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD |                             |           | FLWR | N-2+ae_reply ok-True mi-1   |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD |                             |           | FLWR |                             |           | FLWR | N-1+ae t-1 i-0 lt-0 e-1 c-0 | lt-1 li-1 |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD |                             |           | FLWR |                             |           | FLWR | N-3+ae_reply ok-True mi-1   |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | N-2+ae_reply ok-True mi-1   | ci-1      | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | N-3+ae_reply ok-True mi-1   |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_member_changes/test_add_follower_2_1.puml
          :scale: 100%


Section 2: Node 1 is leader, inserting some records via direct acceess to logs
==============================================================================




.. collapse:: section 2 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----+-------+------+-----+-------+------+-----+-------+------+-----+-------+
   | N-1  | N-1 | N-1   | N-2  | N-2 | N-2   | N-3  | N-3 | N-3   | N-4  | N-4 | N-4   |
   +------+-----+-------+------+-----+-------+------+-----+-------+------+-----+-------+
   | Role | Op  | Delta | Role | Op  | Delta | Role | Op  | Delta | Role | Op  | Delta |
   +------+-----+-------+------+-----+-------+------+-----+-------+------+-----+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_member_changes/test_add_follower_2_2.puml
          :scale: 100%


Section 3: Records inserted, starting add of node 4
===================================================




.. collapse:: section 3 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+------------------------------------+-------+------+-----+-------+------+-----+-------+------+------------------------------------+----------------+
   | N-1  | N-1                                | N-1   | N-2  | N-2 | N-2   | N-3  | N-3 | N-3   | N-4  | N-4                                | N-4            |
   +------+------------------------------------+-------+------+-----+-------+------+-----+-------+------+------------------------------------+----------------+
   | Role | Op                                 | Delta | Role | Op  | Delta | Role | Op  | Delta | Role | Op                                 | Delta          |
   +======+====================================+=======+======+=====+=======+======+=====+=======+======+====================================+================+
   | LEAD |                                    |       | FLWR |     |       | FLWR |     |       | FLWR | m_c+N-1 op-ADD n-mcpy://4          |                |
   +------+------------------------------------+-------+------+-----+-------+------+-----+-------+------+------------------------------------+----------------+
   | LEAD | N-4+m_c op-ADD n-mcpy://4          |       | FLWR |     |       | FLWR |     |       | FLWR |                                    |                |
   +------+------------------------------------+-------+------+-----+-------+------+-----+-------+------+------------------------------------+----------------+
   | LEAD | ae+N-4 t-1 i-32 lt-1 e-0 c-32      |       | FLWR |     |       | FLWR |     |       | FLWR |                                    |                |
   +------+------------------------------------+-------+------+-----+-------+------+-----+-------+------+------------------------------------+----------------+
   | LEAD |                                    |       | FLWR |     |       | FLWR |     |       | FLWR | N-1+ae t-1 i-32 lt-1 e-0 c-32      | t-1            |
   +------+------------------------------------+-------+------+-----+-------+------+-----+-------+------+------------------------------------+----------------+
   | LEAD |                                    |       | FLWR |     |       | FLWR |     |       | FLWR | N-4+ae_reply ok-False mi-0         |                |
   +------+------------------------------------+-------+------+-----+-------+------+-----+-------+------+------------------------------------+----------------+
   | LEAD | N-4+ae_reply ok-False mi-0         |       | FLWR |     |       | FLWR |     |       | FLWR |                                    |                |
   +------+------------------------------------+-------+------+-----+-------+------+-----+-------+------+------------------------------------+----------------+
   | LEAD | ae+N-4 t-1 i-0 lt-0 e-1 c-32       |       | FLWR |     |       | FLWR |     |       | FLWR |                                    |                |
   +------+------------------------------------+-------+------+-----+-------+------+-----+-------+------+------------------------------------+----------------+
   | LEAD |                                    |       | FLWR |     |       | FLWR |     |       | FLWR | N-1+ae t-1 i-0 lt-0 e-1 c-32       | lt-1 li-1 ci-1 |
   +------+------------------------------------+-------+------+-----+-------+------+-----+-------+------+------------------------------------+----------------+
   | LEAD |                                    |       | FLWR |     |       | FLWR |     |       | FLWR | N-4+ae_reply ok-True mi-1          |                |
   +------+------------------------------------+-------+------+-----+-------+------+-----+-------+------+------------------------------------+----------------+
   | LEAD | N-4+ae_reply ok-True mi-1          |       | FLWR |     |       | FLWR |     |       | FLWR |                                    |                |
   +------+------------------------------------+-------+------+-----+-------+------+-----+-------+------+------------------------------------+----------------+
   | LEAD | ae+N-4 t-1 i-1 lt-1 e-11 c-32      |       | FLWR |     |       | FLWR |     |       | FLWR |                                    |                |
   +------+------------------------------------+-------+------+-----+-------+------+-----+-------+------+------------------------------------+----------------+
   | LEAD |                                    |       | FLWR |     |       | FLWR |     |       | FLWR | N-1+ae t-1 i-1 lt-1 e-11 c-32      | li-12 ci-12    |
   +------+------------------------------------+-------+------+-----+-------+------+-----+-------+------+------------------------------------+----------------+
   | LEAD |                                    |       | FLWR |     |       | FLWR |     |       | FLWR | N-4+ae_reply ok-True mi-12         |                |
   +------+------------------------------------+-------+------+-----+-------+------+-----+-------+------+------------------------------------+----------------+
   | LEAD | N-4+ae_reply ok-True mi-12         |       | FLWR |     |       | FLWR |     |       | FLWR |                                    |                |
   +------+------------------------------------+-------+------+-----+-------+------+-----+-------+------+------------------------------------+----------------+
   | LEAD | ae+N-4 t-1 i-12 lt-1 e-11 c-32     |       | FLWR |     |       | FLWR |     |       | FLWR |                                    |                |
   +------+------------------------------------+-------+------+-----+-------+------+-----+-------+------+------------------------------------+----------------+
   | LEAD |                                    |       | FLWR |     |       | FLWR |     |       | FLWR | N-1+ae t-1 i-12 lt-1 e-11 c-32     | li-23 ci-23    |
   +------+------------------------------------+-------+------+-----+-------+------+-----+-------+------+------------------------------------+----------------+
   | LEAD |                                    |       | FLWR |     |       | FLWR |     |       | FLWR | N-4+ae_reply ok-True mi-23         |                |
   +------+------------------------------------+-------+------+-----+-------+------+-----+-------+------+------------------------------------+----------------+
   | LEAD | N-4+ae_reply ok-True mi-23         |       | FLWR |     |       | FLWR |     |       | FLWR |                                    |                |
   +------+------------------------------------+-------+------+-----+-------+------+-----+-------+------+------------------------------------+----------------+
   | LEAD | ae+N-4 t-1 i-23 lt-1 e-9 c-32      |       | FLWR |     |       | FLWR |     |       | FLWR |                                    |                |
   +------+------------------------------------+-------+------+-----+-------+------+-----+-------+------+------------------------------------+----------------+
   | LEAD |                                    |       | FLWR |     |       | FLWR |     |       | FLWR | N-1+ae t-1 i-23 lt-1 e-9 c-32      | li-32 ci-32    |
   +------+------------------------------------+-------+------+-----+-------+------+-----+-------+------+------------------------------------+----------------+
   | LEAD |                                    |       | FLWR |     |       | FLWR |     |       | FLWR | N-4+ae_reply ok-True mi-32         |                |
   +------+------------------------------------+-------+------+-----+-------+------+-----+-------+------+------------------------------------+----------------+
   | LEAD | N-4+ae_reply ok-True mi-32         | li-33 | FLWR |     |       | FLWR |     |       | FLWR |                                    |                |
   +------+------------------------------------+-------+------+-----+-------+------+-----+-------+------+------------------------------------+----------------+
   | LEAD | m_cr+N-4 op-ADD n-mcpy://4 ok-True |       | FLWR |     |       | FLWR |     |       | FLWR |                                    |                |
   +------+------------------------------------+-------+------+-----+-------+------+-----+-------+------+------------------------------------+----------------+
   | LEAD |                                    |       | FLWR |     |       | FLWR |     |       | FLWR | N-1+m_cr op-ADD n-mcpy://4 ok-True |                |
   +------+------------------------------------+-------+------+-----+-------+------+-----+-------+------+------------------------------------+----------------+
   | LEAD | ae+N-4 t-1 i-32 lt-1 e-1 c-32      |       | FLWR |     |       | FLWR |     |       | FLWR |                                    |                |
   +------+------------------------------------+-------+------+-----+-------+------+-----+-------+------+------------------------------------+----------------+
   | LEAD |                                    |       | FLWR |     |       | FLWR |     |       | FLWR | N-1+ae t-1 i-32 lt-1 e-1 c-32      | li-33          |
   +------+------------------------------------+-------+------+-----+-------+------+-----+-------+------+------------------------------------+----------------+
   | LEAD |                                    |       | FLWR |     |       | FLWR |     |       | FLWR | N-4+ae_reply ok-True mi-33         |                |
   +------+------------------------------------+-------+------+-----+-------+------+-----+-------+------+------------------------------------+----------------+
   | LEAD | N-4+ae_reply ok-True mi-33         | ci-33 | FLWR |     |       | FLWR |     |       | FLWR |                                    |                |
   +------+------------------------------------+-------+------+-----+-------+------+-----+-------+------+------------------------------------+----------------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_member_changes/test_add_follower_2_3.puml
          :scale: 100%


