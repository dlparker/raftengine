.. _test_reverse_remove_follower_3:

=================================================================
Test test_reverse_remove_follower_3 from file test_member_changes
=================================================================


    This test is tricky to setup. The targeted condition is that a node tries to exit the cluster, and it
    has received the membership change log record, but it has not yet been committed, then it
    is told to remove the record because it is superceeded by the same index at a later term.
    At this point it should reverse the exit and remain in the cluster.

    To make this happen, we start with a five node cluster. We run election, run a command, then start
    node 5 down the exit path. When the leader has recorded the change in the log and is ready to
    send it out for replication we partion the network so that the leader and the exiting node are
    together on a minority network. We allow the exiting node to get the append entries record and
    apply it, but the leader can't get a commit because the other nodes are unreachable. So both
    leader and node 5 have applied and saved the removal of node 5. The record index will be 3 and the term
    will be 1.

    At this point we trigger node 2 to run a new election which it will win, saving a TERM START record
    at index 3 and term 2.

    Now the network will be healed, and the new leader will be triggered to send heartbeats. This will
    result in the two minority nodes realizing that their last log records are invalid because of the
    new term in the heartbeat spec for last log record term. This will cause and overwrite and
    a reversal of the cluster membership change.
    
    Timers are disabled, so all timer driven operations such as heartbeats are manually triggered.

    

Section 1: Normal election
==========================




.. collapse:: section 1 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | N-1  | N-1                         | N-1       | N-2  | N-2                         | N-2       | N-3  | N-3                         | N-3       | N-4  | N-4                         | N-4       | N-5  | N-5                         | N-5       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | Role | Op                          | Delta     | Role | Op                          | Delta     | Role | Op                          | Delta     | Role | Op                          | Delta     | Role | Op                          | Delta     |
   +======+=============================+===========+======+=============================+===========+======+=============================+===========+======+=============================+===========+======+=============================+===========+
   | CNDI | NEW ROLE                    |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI | poll+N-2 t-1 li-0 lt-1      |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI | poll+N-3 t-1 li-0 lt-1      |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI | poll+N-4 t-1 li-0 lt-1      |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI | poll+N-5 t-1 li-0 lt-1      |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI |                             |           | FLWR | N-1+poll t-1 li-0 lt-1      | t-1       | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI |                             |           | FLWR | vote+N-1 yes-True           |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI |                             |           | FLWR |                             |           | FLWR | N-1+poll t-1 li-0 lt-1      | t-1       | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI |                             |           | FLWR |                             |           | FLWR | vote+N-1 yes-True           |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR | N-1+poll t-1 li-0 lt-1      | t-1       | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR | vote+N-1 yes-True           |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR | N-1+poll t-1 li-0 lt-1      | t-1       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR | vote+N-1 yes-True           |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI | N-2+vote yes-True           |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | N-3+vote yes-True           | lt-1 li-1 | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | NEW ROLE                    |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | ae+N-2 t-1 i-0 lt-0 e-1 c-0 |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | ae+N-3 t-1 i-0 lt-0 e-1 c-0 |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | ae+N-4 t-1 i-0 lt-0 e-1 c-0 |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | ae+N-5 t-1 i-0 lt-0 e-1 c-0 |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | N-4+vote yes-True           |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | N-5+vote yes-True           |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |                             |           | FLWR | N-1+ae t-1 i-0 lt-0 e-1 c-0 | lt-1 li-1 | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |                             |           | FLWR | N-2+ae_reply ok-True mi-1   |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |                             |           | FLWR |                             |           | FLWR | N-1+ae t-1 i-0 lt-0 e-1 c-0 | lt-1 li-1 | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |                             |           | FLWR |                             |           | FLWR | N-3+ae_reply ok-True mi-1   |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR | N-1+ae t-1 i-0 lt-0 e-1 c-0 | lt-1 li-1 | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR | N-4+ae_reply ok-True mi-1   |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR | N-1+ae t-1 i-0 lt-0 e-1 c-0 | lt-1 li-1 |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR | N-5+ae_reply ok-True mi-1   |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | N-2+ae_reply ok-True mi-1   |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | N-3+ae_reply ok-True mi-1   | ci-1      | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | N-4+ae_reply ok-True mi-1   |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | N-5+ae_reply ok-True mi-1   |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_member_changes/test_reverse_remove_follower_3_1.puml
          :scale: 100%


Section 2: Node 1 is leader, running a command, then starting cluster exit at node 5
====================================================================================




.. collapse:: section 2 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+------------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | N-1  | N-1                          | N-1   | N-2  | N-2                         | N-2   | N-3  | N-3                         | N-3   | N-4  | N-4                         | N-4   | N-5  | N-5                         | N-5   |
   +------+------------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | Role | Op                           | Delta | Role | Op                          | Delta | Role | Op                          | Delta | Role | Op                          | Delta | Role | Op                          | Delta |
   +======+==============================+=======+======+=============================+=======+======+=============================+=======+======+=============================+=======+======+=============================+=======+
   | LEAD | CMD START                    |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |       |
   +------+------------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | LEAD | ae+N-2 t-1 i-1 lt-1 e-1 c-1  | li-2  | FLWR |                             |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |       |
   +------+------------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | LEAD | ae+N-3 t-1 i-1 lt-1 e-1 c-1  |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |       |
   +------+------------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | LEAD | ae+N-4 t-1 i-1 lt-1 e-1 c-1  |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |       |
   +------+------------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | LEAD | ae+N-5 t-1 i-1 lt-1 e-1 c-1  |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |       |
   +------+------------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | LEAD |                              |       | FLWR | N-1+ae t-1 i-1 lt-1 e-1 c-1 | li-2  | FLWR |                             |       | FLWR |                             |       | FLWR |                             |       |
   +------+------------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | LEAD |                              |       | FLWR | N-2+ae_reply ok-True mi-2   |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |       |
   +------+------------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | LEAD |                              |       | FLWR |                             |       | FLWR | N-1+ae t-1 i-1 lt-1 e-1 c-1 | li-2  | FLWR |                             |       | FLWR |                             |       |
   +------+------------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | LEAD |                              |       | FLWR |                             |       | FLWR | N-3+ae_reply ok-True mi-2   |       | FLWR |                             |       | FLWR |                             |       |
   +------+------------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | LEAD |                              |       | FLWR |                             |       | FLWR |                             |       | FLWR | N-1+ae t-1 i-1 lt-1 e-1 c-1 | li-2  | FLWR |                             |       |
   +------+------------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | LEAD |                              |       | FLWR |                             |       | FLWR |                             |       | FLWR | N-4+ae_reply ok-True mi-2   |       | FLWR |                             |       |
   +------+------------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | LEAD |                              |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |       | FLWR | N-1+ae t-1 i-1 lt-1 e-1 c-1 | li-2  |
   +------+------------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | LEAD |                              |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |       | FLWR | N-5+ae_reply ok-True mi-2   |       |
   +------+------------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | LEAD | N-2+ae_reply ok-True mi-2    |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |       |
   +------+------------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | LEAD | N-3+ae_reply ok-True mi-2    | ci-2  | FLWR |                             |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |       |
   +------+------------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | LEAD | N-4+ae_reply ok-True mi-2    |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |       |
   +------+------------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | LEAD | N-5+ae_reply ok-True mi-2    |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |       |
   +------+------------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | LEAD |                              |       | FLWR | N-1+ae t-1 i-2 lt-1 e-0 c-2 | ci-2  | FLWR |                             |       | FLWR |                             |       | FLWR |                             |       |
   +------+------------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | LEAD |                              |       | FLWR |                             |       | FLWR | N-1+ae t-1 i-2 lt-1 e-0 c-2 | ci-2  | FLWR |                             |       | FLWR |                             |       |
   +------+------------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | LEAD |                              |       | FLWR |                             |       | FLWR |                             |       | FLWR | N-1+ae t-1 i-2 lt-1 e-0 c-2 | ci-2  | FLWR |                             |       |
   +------+------------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | LEAD |                              |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |       | FLWR | N-1+ae t-1 i-2 lt-1 e-0 c-2 | ci-2  |
   +------+------------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | LEAD | CMD DONE                     |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |       |
   +------+------------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | LEAD | N-5+m_c op-REMOVE n-mcpy://5 | li-3  | FLWR |                             |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |       |
   +------+------------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_member_changes/test_reverse_remove_follower_3_2.puml
          :scale: 100%


Section 3: Leader has saved member change log record, splitting network, delivering pending, starting election
==============================================================================================================




.. collapse:: section 3 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----------------------------+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+----------+
   | N-1  | N-1                         | N-1   | N-2  | N-2                         | N-2       | N-3  | N-3                         | N-3       | N-4  | N-4                         | N-4       | N-5  | N-5                         | N-5      |
   +------+-----------------------------+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+----------+
   | Role | Op                          | Delta | Role | Op                          | Delta     | Role | Op                          | Delta     | Role | Op                          | Delta     | Role | Op                          | Delta    |
   +======+=============================+=======+======+=============================+===========+======+=============================+===========+======+=============================+===========+======+=============================+==========+
   | LEAD | NETSPLIT                    |       | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             |          |
   +------+-----------------------------+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+----------+
   | LEAD |                             | n=2   | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR | NETSPLIT                    | n=2      |
   +------+-----------------------------+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+----------+
   | LEAD | ae+N-5 t-1 i-2 lt-1 e-1 c-2 | n=2   | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             | n=2      |
   +------+-----------------------------+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+----------+
   | LEAD |                             | n=2   | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR | N-1+ae t-1 i-2 lt-1 e-1 c-2 | li-3 n=2 |
   +------+-----------------------------+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+----------+
   | LEAD |                             | n=2   | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR | N-5+ae_reply ok-True mi-2   | n=2      |
   +------+-----------------------------+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+----------+
   | LEAD | N-5+ae_reply ok-True mi-2   | n=2   | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             | n=2      |
   +------+-----------------------------+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+----------+
   | LEAD | ae+N-5 t-1 i-2 lt-1 e-1 c-2 | n=2   | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             | n=2      |
   +------+-----------------------------+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+----------+
   | LEAD |                             | n=2   | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR | N-1+ae t-1 i-2 lt-1 e-1 c-2 | n=2      |
   +------+-----------------------------+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+----------+
   | LEAD |                             | n=2   | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR | N-5+ae_reply ok-True mi-3   | n=2      |
   +------+-----------------------------+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+----------+
   | LEAD | N-5+ae_reply ok-True mi-3   | n=2   | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             | n=2      |
   +------+-----------------------------+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+----------+
   | LEAD |                             | n=2   | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR | N-5+ae_reply ok-True mi-3   | n=2      |
   +------+-----------------------------+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+----------+
   | LEAD | N-5+ae_reply ok-True mi-3   | n=2   | FLWR |                             |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             | n=2      |
   +------+-----------------------------+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+----------+
   | LEAD |                             | n=2   | CNDI | NEW ROLE                    | t-2       | FLWR |                             |           | FLWR |                             |           | FLWR |                             | n=2      |
   +------+-----------------------------+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+----------+
   | LEAD |                             | n=2   | CNDI | poll+N-3 t-2 li-2 lt-2      |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             | n=2      |
   +------+-----------------------------+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+----------+
   | LEAD |                             | n=2   | CNDI | poll+N-4 t-2 li-2 lt-2      |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             | n=2      |
   +------+-----------------------------+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+----------+
   | LEAD |                             | n=2   | CNDI |                             |           | FLWR | N-2+poll t-2 li-2 lt-2      | t-2       | FLWR |                             |           | FLWR |                             | n=2      |
   +------+-----------------------------+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+----------+
   | LEAD |                             | n=2   | CNDI |                             |           | FLWR | vote+N-2 yes-True           |           | FLWR |                             |           | FLWR |                             | n=2      |
   +------+-----------------------------+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+----------+
   | LEAD |                             | n=2   | CNDI |                             |           | FLWR |                             |           | FLWR | N-2+poll t-2 li-2 lt-2      | t-2       | FLWR |                             | n=2      |
   +------+-----------------------------+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+----------+
   | LEAD |                             | n=2   | CNDI |                             |           | FLWR |                             |           | FLWR | vote+N-2 yes-True           |           | FLWR |                             | n=2      |
   +------+-----------------------------+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+----------+
   | LEAD |                             | n=2   | CNDI | N-3+vote yes-True           |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             | n=2      |
   +------+-----------------------------+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+----------+
   | LEAD |                             | n=2   | LEAD | N-4+vote yes-True           | lt-2 li-3 | FLWR |                             |           | FLWR |                             |           | FLWR |                             | n=2      |
   +------+-----------------------------+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+----------+
   | LEAD |                             | n=2   | LEAD | NEW ROLE                    |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             | n=2      |
   +------+-----------------------------+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+----------+
   | LEAD |                             | n=2   | LEAD | ae+N-3 t-2 i-2 lt-1 e-1 c-2 |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             | n=2      |
   +------+-----------------------------+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+----------+
   | LEAD |                             | n=2   | LEAD | ae+N-4 t-2 i-2 lt-1 e-1 c-2 |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             | n=2      |
   +------+-----------------------------+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+----------+
   | LEAD |                             | n=2   | LEAD |                             |           | FLWR | N-2+ae t-2 i-2 lt-1 e-1 c-2 | lt-2 li-3 | FLWR |                             |           | FLWR |                             | n=2      |
   +------+-----------------------------+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+----------+
   | LEAD |                             | n=2   | LEAD |                             |           | FLWR | N-3+ae_reply ok-True mi-3   |           | FLWR |                             |           | FLWR |                             | n=2      |
   +------+-----------------------------+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+----------+
   | LEAD |                             | n=2   | LEAD |                             |           | FLWR |                             |           | FLWR | N-2+ae t-2 i-2 lt-1 e-1 c-2 | lt-2 li-3 | FLWR |                             | n=2      |
   +------+-----------------------------+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+----------+
   | LEAD |                             | n=2   | LEAD |                             |           | FLWR |                             |           | FLWR | N-4+ae_reply ok-True mi-3   |           | FLWR |                             | n=2      |
   +------+-----------------------------+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+----------+
   | LEAD |                             | n=2   | LEAD | N-3+ae_reply ok-True mi-3   |           | FLWR |                             |           | FLWR |                             |           | FLWR |                             | n=2      |
   +------+-----------------------------+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+----------+
   | LEAD |                             | n=2   | LEAD | N-4+ae_reply ok-True mi-3   | ci-3      | FLWR |                             |           | FLWR |                             |           | FLWR |                             | n=2      |
   +------+-----------------------------+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+----------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_member_changes/test_reverse_remove_follower_3_3.puml
          :scale: 100%


Section 4: Log state verified, healing partition and triggering heartbeats
==========================================================================




.. collapse:: section 4 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | N-1  | N-1                         | N-1       | N-2  | N-2                         | N-2   | N-3  | N-3                         | N-3   | N-4  | N-4                         | N-4   | N-5  | N-5                         | N-5       |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | Role | Op                          | Delta     | Role | Op                          | Delta | Role | Op                          | Delta | Role | Op                          | Delta | Role | Op                          | Delta     |
   +======+=============================+===========+======+=============================+=======+======+=============================+=======+======+=============================+=======+======+=============================+===========+
   | LEAD | NETJOIN                     | n=1       | LEAD |                             |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | LEAD |                             |           | LEAD |                             |       | FLWR |                             |       | FLWR |                             |       | FLWR | NETJOIN                     | n=1       |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | LEAD |                             |           | LEAD | ae+N-1 t-2 i-3 lt-2 e-0 c-3 |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR | N-2+ae t-2 i-3 lt-2 e-0 c-3 | t-2       | LEAD |                             |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR | NEW ROLE                    |           | LEAD |                             |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR | N-1+ae_reply ok-False mi-3  |           | LEAD |                             |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD | N-1+ae_reply ok-False mi-3  |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD | ae+N-3 t-2 i-3 lt-2 e-0 c-3 |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD |                             |       | FLWR | N-2+ae t-2 i-3 lt-2 e-0 c-3 | ci-3  | FLWR |                             |       | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD |                             |       | FLWR | N-3+ae_reply ok-True mi-3   |       | FLWR |                             |       | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD | N-3+ae_reply ok-True mi-3   |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD | ae+N-4 t-2 i-3 lt-2 e-0 c-3 |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD |                             |       | FLWR |                             |       | FLWR | N-2+ae t-2 i-3 lt-2 e-0 c-3 | ci-3  | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD |                             |       | FLWR |                             |       | FLWR | N-4+ae_reply ok-True mi-3   |       | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD | N-4+ae_reply ok-True mi-3   |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD | ae+N-5 t-2 i-3 lt-2 e-0 c-3 |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD |                             |       | FLWR |                             |       | FLWR |                             |       | FLWR | N-2+ae t-2 i-3 lt-2 e-0 c-3 | t-2       |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD |                             |       | FLWR |                             |       | FLWR |                             |       | FLWR | N-5+ae_reply ok-False mi-3  |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD | N-5+ae_reply ok-False mi-3  |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD | ae+N-1 t-2 i-2 lt-1 e-1 c-3 |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR | N-2+ae t-2 i-2 lt-1 e-1 c-3 | lt-2 ci-3 | LEAD |                             |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR | N-1+ae_reply ok-True mi-3   |           | LEAD |                             |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD | N-1+ae_reply ok-True mi-3   |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD | ae+N-5 t-2 i-2 lt-1 e-1 c-3 |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD |                             |       | FLWR |                             |       | FLWR |                             |       | FLWR | N-2+ae t-2 i-2 lt-1 e-1 c-3 | lt-2 ci-3 |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD |                             |       | FLWR |                             |       | FLWR |                             |       | FLWR | N-5+ae_reply ok-True mi-3   |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD | N-5+ae_reply ok-True mi-3   |       | FLWR |                             |       | FLWR |                             |       | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-------+------+-----------------------------+-----------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_member_changes/test_reverse_remove_follower_3_4.puml
          :scale: 100%


