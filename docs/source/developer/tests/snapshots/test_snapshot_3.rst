.. _test_snapshot_3:

=============================================
Test test_snapshot_3 from file test_snapshots
=============================================


    Test the snapshot process when the leader is told to snapshot. It should
    transfer power and then do the snapshot, then rejoin cluster. Also tests
    that a node joining the cluster will get the snapshot installed during
    pre-add log loading.

    Timers are disabled, so all timer driven operations such as heartbeats are manually triggered.
    

Section 2: Running election to elect node 1
===========================================



.. collapse:: section 2 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | N-1  | N-1                         | N-1       | N-2  | N-2                         | N-2       | N-3  | N-3                         | N-3       | N-4  | N-4 | N-4   |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | Role | Op                          | Delta     | Role | Op                          | Delta     | Role | Op                          | Delta     | Role | Op  | Delta |
   +======+=============================+===========+======+=============================+===========+======+=============================+===========+======+=====+=======+
   | CNDI | NEW ROLE                    |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | CNDI | poll+N-2 t-1 li-0 lt-1      |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | CNDI | poll+N-3 t-1 li-0 lt-1      |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | CNDI |                             |           | FLWR | N-1+poll t-1 li-0 lt-1      | t-1       | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | CNDI |                             |           | FLWR | vote+N-1 yes-True           |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | CNDI |                             |           | FLWR |                             |           | FLWR | N-1+poll t-1 li-0 lt-1      | t-1       |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | CNDI |                             |           | FLWR |                             |           | FLWR | vote+N-1 yes-True           |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | N-2+vote yes-True           | lt-1 li-1 | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | NEW ROLE                    |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | ae+N-2 t-1 i-0 lt-0 e-1 c-0 |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | ae+N-3 t-1 i-0 lt-0 e-1 c-0 |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | N-3+vote yes-True           |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD |                             |           | FLWR | N-1+ae t-1 i-0 lt-0 e-1 c-0 | lt-1 li-1 | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD |                             |           | FLWR | N-2+ae_reply ok-True mi-1   |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD |                             |           | FLWR |                             |           | FLWR | N-1+ae t-1 i-0 lt-0 e-1 c-0 | lt-1 li-1 |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD |                             |           | FLWR |                             |           | FLWR | N-3+ae_reply ok-True mi-1   |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | N-2+ae_reply ok-True mi-1   | ci-1      | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | N-3+ae_reply ok-True mi-1   |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | ae+N-2 t-1 i-1 lt-1 e-0 c-1 |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD |                             |           | FLWR | N-1+ae t-1 i-1 lt-1 e-0 c-1 | ci-1      | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD |                             |           | FLWR | N-2+ae_reply ok-True mi-1   |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | N-2+ae_reply ok-True mi-1   |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | ae+N-3 t-1 i-1 lt-1 e-0 c-1 |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD |                             |           | FLWR |                             |           | FLWR | N-1+ae t-1 i-1 lt-1 e-0 c-1 | ci-1      |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD |                             |           | FLWR |                             |           | FLWR | N-3+ae_reply ok-True mi-1   |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | N-3+ae_reply ok-True mi-1   |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_snapshots/test_snapshot_3_2.puml
          :scale: 100%


Section 3: Node 1 is leader, runing commands by direct fake path
================================================================



.. collapse:: section 3 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----+-------+------+-----+-------+------+-----+-------+------+-----+-------+
   | N-1  | N-1 | N-1   | N-2  | N-2 | N-2   | N-3  | N-3 | N-3   | N-4  | N-4 | N-4   |
   +------+-----+-------+------+-----+-------+------+-----+-------+------+-----+-------+
   | Role | Op  | Delta | Role | Op  | Delta | Role | Op  | Delta | Role | Op  | Delta |
   +------+-----+-------+------+-----+-------+------+-----+-------+------+-----+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_snapshots/test_snapshot_3_3.puml
          :scale: 100%


Section 4: Telling leader node (node 1) to snapshot but blocking net, should fail because it can't transfer power
=================================================================================================================



.. collapse:: section 4 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----+-------+------+-----+-------+------+-----+-------+------+-----+-------+
   | N-1  | N-1 | N-1   | N-2  | N-2 | N-2   | N-3  | N-3 | N-3   | N-4  | N-4 | N-4   |
   +------+-----+-------+------+-----+-------+------+-----+-------+------+-----+-------+
   | Role | Op  | Delta | Role | Op  | Delta | Role | Op  | Delta | Role | Op  | Delta |
   +------+-----+-------+------+-----+-------+------+-----+-------+------+-----+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_snapshots/test_snapshot_3_4.puml
          :scale: 100%


Section 5: Telling leader node (node 1) to snapshot, should make it transfer power
==================================================================================



.. collapse:: section 5 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----+-------+------+-----+-------+------+-----+-------+------+-----+-------+
   | N-1  | N-1 | N-1   | N-2  | N-2 | N-2   | N-3  | N-3 | N-3   | N-4  | N-4 | N-4   |
   +------+-----+-------+------+-----+-------+------+-----+-------+------+-----+-------+
   | Role | Op  | Delta | Role | Op  | Delta | Role | Op  | Delta | Role | Op  | Delta |
   +------+-----+-------+------+-----+-------+------+-----+-------+------+-----+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_snapshots/test_snapshot_3_5.puml
          :scale: 100%


Section 6: Node 1 has snapshot and empty log, {new_leader.uri} is leader, running command
=========================================================================================



.. collapse:: section 6 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----+-------+------+-----+-------+------+-----+-------+------+-----+-------+
   | N-1  | N-1 | N-1   | N-2  | N-2 | N-2   | N-3  | N-3 | N-3   | N-4  | N-4 | N-4   |
   +------+-----+-------+------+-----+-------+------+-----+-------+------+-----+-------+
   | Role | Op  | Delta | Role | Op  | Delta | Role | Op  | Delta | Role | Op  | Delta |
   +------+-----+-------+------+-----+-------+------+-----+-------+------+-----+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_snapshots/test_snapshot_3_6.puml
          :scale: 100%


Section 7: Changing leader back to node 1 so that join will process snapshot
============================================================================



.. collapse:: section 7 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----+-------+------+-----+-------+------+-----+-------+------+-----+-------+
   | N-1  | N-1 | N-1   | N-2  | N-2 | N-2   | N-3  | N-3 | N-3   | N-4  | N-4 | N-4   |
   +------+-----+-------+------+-----+-------+------+-----+-------+------+-----+-------+
   | Role | Op  | Delta | Role | Op  | Delta | Role | Op  | Delta | Role | Op  | Delta |
   +------+-----+-------+------+-----+-------+------+-----+-------+------+-----+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_snapshots/test_snapshot_3_7.puml
          :scale: 100%


Section 8: Adding a node to and checking that it receives snapshot before joining
=================================================================================



.. collapse:: section 8 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----+-------+------+-----+-------+------+-----+-------+------+-----+-------+
   | N-1  | N-1 | N-1   | N-2  | N-2 | N-2   | N-3  | N-3 | N-3   | N-4  | N-4 | N-4   |
   +------+-----+-------+------+-----+-------+------+-----+-------+------+-----+-------+
   | Role | Op  | Delta | Role | Op  | Delta | Role | Op  | Delta | Role | Op  | Delta |
   +------+-----+-------+------+-----+-------+------+-----+-------+------+-----+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_snapshots/test_snapshot_3_8.puml
          :scale: 100%


