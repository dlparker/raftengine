.. _test_snapshot_3:

=============================================
Test test_snapshot_3 from file test_snapshots
=============================================


    Test the snapshot process when the leader is told to snapshot. It should
    transfer power and then do the snapshot, then rejoin cluster. Also tests
    that a node joining the cluster will get the snapshot installed during
    pre-add log loading.

    Timers are disabled, so all timer driven operations such as heartbeats are manually triggered.
    

Section 1: Running election to elect node 1
===========================================




.. collapse:: section 1 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | N-1  | N-1                         | N-1       | N-2  | N-2                         | N-2       | N-3  | N-3                         | N-3       | N-4  | N-4 | N-4   |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | Role | Op                          | Delta     | Role | Op                          | Delta     | Role | Op                          | Delta     | Role | Op  | Delta |
   +======+=============================+===========+======+=============================+===========+======+=============================+===========+======+=====+=======+
   | CNDI | NEW ROLE                    |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | CNDI | poll+N-2 t-1 li-0 lt-1      |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | CNDI | poll+N-3 t-1 li-0 lt-1      |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | CNDI |                             |           | FLWR | N-1+poll t-1 li-0 lt-1      | t-1       | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | CNDI |                             |           | FLWR | vote+N-1 yes-True           |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | CNDI |                             |           | FLWR |                             |           | FLWR | N-1+poll t-1 li-0 lt-1      | t-1       |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | CNDI |                             |           | FLWR |                             |           | FLWR | vote+N-1 yes-True           |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | N-2+vote yes-True           | lt-1 li-1 | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | NEW ROLE                    |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | ae+N-2 t-1 i-0 lt-0 e-1 c-0 |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | ae+N-3 t-1 i-0 lt-0 e-1 c-0 |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | N-3+vote yes-True           |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD |                             |           | FLWR | N-1+ae t-1 i-0 lt-0 e-1 c-0 | lt-1 li-1 | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD |                             |           | FLWR | N-2+ae_reply ok-True mi-1   |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD |                             |           | FLWR |                             |           | FLWR | N-1+ae t-1 i-0 lt-0 e-1 c-0 | lt-1 li-1 |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD |                             |           | FLWR |                             |           | FLWR | N-3+ae_reply ok-True mi-1   |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | N-2+ae_reply ok-True mi-1   | ci-1      | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | N-3+ae_reply ok-True mi-1   |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | ae+N-2 t-1 i-1 lt-1 e-0 c-1 |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD |                             |           | FLWR | N-1+ae t-1 i-1 lt-1 e-0 c-1 | ci-1      | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD |                             |           | FLWR | N-2+ae_reply ok-True mi-1   |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | N-2+ae_reply ok-True mi-1   |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | ae+N-3 t-1 i-1 lt-1 e-0 c-1 |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD |                             |           | FLWR |                             |           | FLWR | N-1+ae t-1 i-1 lt-1 e-0 c-1 | ci-1      |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD |                             |           | FLWR |                             |           | FLWR | N-3+ae_reply ok-True mi-1   |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+
   | LEAD | N-3+ae_reply ok-True mi-1   |           | FLWR |                             |           | FLWR |                             |           |      |     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_snapshots/test_snapshot_3_1.puml
          :scale: 100%


Section 2: Node 1 is leader, runing commands by direct fake path
================================================================




.. collapse:: section 2 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----+-------+------+-----+-------+------+-----+-------+------+-----+-------+
   | N-1  | N-1 | N-1   | N-2  | N-2 | N-2   | N-3  | N-3 | N-3   | N-4  | N-4 | N-4   |
   +------+-----+-------+------+-----+-------+------+-----+-------+------+-----+-------+
   | Role | Op  | Delta | Role | Op  | Delta | Role | Op  | Delta | Role | Op  | Delta |
   +------+-----+-------+------+-----+-------+------+-----+-------+------+-----+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_snapshots/test_snapshot_3_2.puml
          :scale: 100%


Section 3: Telling leader node (node 1) to snapshot but blocking net, should fail because it can't transfer power
=================================================================================================================




.. collapse:: section 3 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----+-------+------+-----+-------+------+-----+-------+------+-----+-------+
   | N-1  | N-1 | N-1   | N-2  | N-2 | N-2   | N-3  | N-3 | N-3   | N-4  | N-4 | N-4   |
   +------+-----+-------+------+-----+-------+------+-----+-------+------+-----+-------+
   | Role | Op  | Delta | Role | Op  | Delta | Role | Op  | Delta | Role | Op  | Delta |
   +------+-----+-------+------+-----+-------+------+-----+-------+------+-----+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_snapshots/test_snapshot_3_3.puml
          :scale: 100%


Section 4: Telling leader node (node 1) to snapshot, should make it transfer power
==================================================================================




.. collapse:: section 4 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | N-1  | N-1                             | N-1         | N-2  | N-2                             | N-2         | N-3  | N-3                             | N-3         | N-4  | N-4 | N-4   |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | Role | Op                              | Delta       | Role | Op                              | Delta       | Role | Op                              | Delta       | Role | Op  | Delta |
   +======+=================================+=============+======+=================================+=============+======+=================================+=============+======+=====+=======+
   | LEAD | ae+N-2 t-1 i-101 lt-1 e-0 c-101 |             | FLWR |                                 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD |                                 |             | FLWR | N-1+ae t-1 i-101 lt-1 e-0 c-101 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD |                                 |             | FLWR | N-2+ae_reply ok-True mi-101     |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD | N-2+ae_reply ok-True mi-101     |             | FLWR |                                 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD | ae+N-3 t-1 i-101 lt-1 e-0 c-101 |             | FLWR |                                 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD |                                 |             | FLWR |                                 |             | FLWR | N-1+ae t-1 i-101 lt-1 e-0 c-101 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD |                                 |             | FLWR |                                 |             | FLWR | N-3+ae_reply ok-True mi-101     |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD | N-3+ae_reply ok-True mi-101     |             | FLWR |                                 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD | ae+N-2 t-1 i-101 lt-1 e-0 c-101 |             | FLWR |                                 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD |                                 |             | FLWR | N-1+ae t-1 i-101 lt-1 e-0 c-101 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD |                                 |             | FLWR | N-2+ae_reply ok-True mi-101     |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD | N-2+ae_reply ok-True mi-101     |             | FLWR |                                 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD | ae+N-3 t-1 i-101 lt-1 e-0 c-101 |             | FLWR |                                 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD |                                 |             | FLWR |                                 |             | FLWR | N-1+ae t-1 i-101 lt-1 e-0 c-101 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD |                                 |             | FLWR |                                 |             | FLWR | N-3+ae_reply ok-True mi-101     |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD | N-3+ae_reply ok-True mi-101     |             | FLWR |                                 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD | t_p+N-2 i-101                   |             | FLWR |                                 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD |                                 |             | CNDI | N-1+t_p i-101                   | t-2         | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD |                                 |             | CNDI | NEW ROLE                        |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD |                                 |             | CNDI | t_pr+N-1 i-101 ok-True          |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD | N-2+t_pr i-101 ok-True          |             | CNDI |                                 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD |                                 |             | CNDI | poll+N-1 t-2 li-101 lt-2        |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | FLWR | N-2+poll t-2 li-101 lt-2        | t-2         | CNDI |                                 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | FLWR | NEW ROLE                        |             | CNDI |                                 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | FLWR | vote+N-2 yes-True               |             | CNDI |                                 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | FLWR |                                 |             | LEAD | N-1+vote yes-True               | lt-2 li-102 | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | FLWR |                                 |             | LEAD | NEW ROLE                        |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | FLWR |                                 |             | LEAD | poll+N-3 t-2 li-101 lt-2        |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | FLWR |                                 |             | LEAD |                                 |             | FLWR | N-2+poll t-2 li-101 lt-2        | t-2         |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | FLWR |                                 |             | LEAD |                                 |             | FLWR | vote+N-2 yes-True               |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | FLWR |                                 |             | LEAD | N-3+vote yes-True               |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | FLWR |                                 |             | LEAD | ae+N-1 t-2 i-101 lt-1 e-1 c-101 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | FLWR | N-2+ae t-2 i-101 lt-1 e-1 c-101 | lt-2 li-102 | LEAD |                                 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | FLWR | N-1+ae_reply ok-True mi-102     |             | LEAD |                                 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | FLWR |                                 |             | LEAD | N-1+ae_reply ok-True mi-102     | ci-102      | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | FLWR |                                 |             | LEAD | ae+N-3 t-2 i-101 lt-1 e-1 c-101 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | FLWR |                                 |             | LEAD |                                 |             | FLWR | N-2+ae t-2 i-101 lt-1 e-1 c-101 | lt-2 li-102 |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | FLWR |                                 |             | LEAD |                                 |             | FLWR | N-3+ae_reply ok-True mi-102     |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | FLWR |                                 |             | LEAD | N-3+ae_reply ok-True mi-102     |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_snapshots/test_snapshot_3_4.puml
          :scale: 100%


Section 5: Node 1 has snapshot and empty log, {new_leader.uri} is leader, running command
=========================================================================================




.. collapse:: section 5 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+---------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+-----+-------+
   | N-1  | N-1                             | N-1    | N-2  | N-2                             | N-2    | N-3  | N-3                             | N-3    | N-4  | N-4 | N-4   |
   +------+---------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+-----+-------+
   | Role | Op                              | Delta  | Role | Op                              | Delta  | Role | Op                              | Delta  | Role | Op  | Delta |
   +======+=================================+========+======+=================================+========+======+=================================+========+======+=====+=======+
   | FLWR |                                 |        | LEAD | CMD START                       |        | FLWR |                                 |        |      |     |       |
   +------+---------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+-----+-------+
   | FLWR |                                 |        | LEAD | ae+N-1 t-2 i-102 lt-2 e-1 c-102 | li-103 | FLWR |                                 |        |      |     |       |
   +------+---------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+-----+-------+
   | FLWR |                                 |        | LEAD | ae+N-3 t-2 i-102 lt-2 e-1 c-102 |        | FLWR |                                 |        |      |     |       |
   +------+---------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+-----+-------+
   | FLWR |                                 |        | LEAD |                                 |        | FLWR | N-2+ae t-2 i-102 lt-2 e-1 c-102 | li-103 |      |     |       |
   +------+---------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+-----+-------+
   | FLWR |                                 |        | LEAD |                                 |        | FLWR | N-3+ae_reply ok-True mi-103     |        |      |     |       |
   +------+---------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+-----+-------+
   | FLWR | N-2+ae t-2 i-102 lt-2 e-1 c-102 | li-103 | LEAD |                                 |        | FLWR |                                 |        |      |     |       |
   +------+---------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+-----+-------+
   | FLWR | N-1+ae_reply ok-True mi-103     |        | LEAD |                                 |        | FLWR |                                 |        |      |     |       |
   +------+---------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+-----+-------+
   | FLWR |                                 |        | LEAD | N-3+ae_reply ok-True mi-103     | ci-103 | FLWR |                                 |        |      |     |       |
   +------+---------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+-----+-------+
   | FLWR |                                 |        | LEAD | N-1+ae_reply ok-True mi-103     |        | FLWR |                                 |        |      |     |       |
   +------+---------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+-----+-------+
   | FLWR |                                 |        | LEAD |                                 |        | FLWR | N-2+ae t-2 i-103 lt-2 e-0 c-103 | ci-103 |      |     |       |
   +------+---------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+-----+-------+
   | FLWR |                                 |        | LEAD | CMD DONE                        |        | FLWR |                                 |        |      |     |       |
   +------+---------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+-----+-------+
   | FLWR | N-2+ae t-2 i-103 lt-2 e-0 c-103 | ci-103 | LEAD |                                 |        | FLWR |                                 |        |      |     |       |
   +------+---------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+-----+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_snapshots/test_snapshot_3_5.puml
          :scale: 100%


Section 6: Changing leader back to node 1 so that join will process snapshot
============================================================================




.. collapse:: section 6 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | N-1  | N-1                             | N-1         | N-2  | N-2                             | N-2         | N-3  | N-3                             | N-3         | N-4  | N-4 | N-4   |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | Role | Op                              | Delta       | Role | Op                              | Delta       | Role | Op                              | Delta       | Role | Op  | Delta |
   +======+=================================+=============+======+=================================+=============+======+=================================+=============+======+=====+=======+
   | FLWR |                                 |             | FLWR | NEW ROLE                        |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | CNDI | NEW ROLE                        | t-3         | FLWR |                                 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | CNDI | N-1+ae_reply ok-True mi-103     |             | FLWR |                                 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | CNDI | poll+N-2 t-3 li-103 lt-3        |             | FLWR |                                 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | CNDI | poll+N-3 t-3 li-103 lt-3        |             | FLWR |                                 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | CNDI |                                 |             | FLWR | N-1+ae_reply ok-True mi-103     |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | CNDI |                                 |             | FLWR | N-1+poll t-3 li-103 lt-3        | t-3         | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | CNDI |                                 |             | FLWR | vote+N-1 yes-True               |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | CNDI |                                 |             | FLWR |                                 |             | FLWR | N-3+ae_reply ok-True mi-103     |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | CNDI |                                 |             | FLWR |                                 |             | FLWR | N-1+poll t-3 li-103 lt-3        | t-3         |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | CNDI |                                 |             | FLWR |                                 |             | FLWR | vote+N-1 yes-True               |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD | N-2+vote yes-True               | lt-3 li-104 | FLWR |                                 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD | NEW ROLE                        |             | FLWR |                                 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD | N-3+vote yes-True               |             | FLWR |                                 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD |                                 |             | FLWR | N-3+ae_reply ok-True mi-103     |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD | ae+N-2 t-3 i-104 lt-3 e-0 c-103 |             | FLWR |                                 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD |                                 |             | FLWR | N-1+ae t-3 i-104 lt-3 e-0 c-103 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD |                                 |             | FLWR | N-2+ae_reply ok-False mi-103    |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD | N-2+ae_reply ok-False mi-103    |             | FLWR |                                 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD | ae+N-3 t-3 i-104 lt-3 e-0 c-103 |             | FLWR |                                 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD |                                 |             | FLWR |                                 |             | FLWR | N-1+ae t-3 i-104 lt-3 e-0 c-103 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD |                                 |             | FLWR |                                 |             | FLWR | N-3+ae_reply ok-False mi-103    |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD | N-3+ae_reply ok-False mi-103    |             | FLWR |                                 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD | ae+N-2 t-3 i-103 lt-2 e-1 c-103 |             | FLWR |                                 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD |                                 |             | FLWR | N-1+ae t-3 i-103 lt-2 e-1 c-103 | lt-3 li-104 | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD |                                 |             | FLWR | N-2+ae_reply ok-True mi-104     |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD | N-2+ae_reply ok-True mi-104     | ci-104      | FLWR |                                 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD | ae+N-3 t-3 i-103 lt-2 e-1 c-103 |             | FLWR |                                 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD |                                 |             | FLWR |                                 |             | FLWR | N-1+ae t-3 i-103 lt-2 e-1 c-103 | lt-3 li-104 |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD |                                 |             | FLWR |                                 |             | FLWR | N-3+ae_reply ok-True mi-104     |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+
   | LEAD | N-3+ae_reply ok-True mi-104     |             | FLWR |                                 |             | FLWR |                                 |             |      |     |       |
   +------+---------------------------------+-------------+------+---------------------------------+-------------+------+---------------------------------+-------------+------+-----+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_snapshots/test_snapshot_3_6.puml
          :scale: 100%


Section 7: Adding a node to and checking that it receives snapshot before joining
=================================================================================




.. collapse:: section 7 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | N-1  | N-1                                | N-1    | N-2  | N-2                             | N-2    | N-3  | N-3                             | N-3    | N-4  | N-4                                | N-4                |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | Role | Op                                 | Delta  | Role | Op                              | Delta  | Role | Op                              | Delta  | Role | Op                                 | Delta              |
   +======+====================================+========+======+=================================+========+======+=================================+========+======+====================================+====================+
   | LEAD |                                    |        | FLWR |                                 |        | FLWR |                                 |        | FLWR | m_c+N-1 op-ADD n-mcpy://4          |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD | N-4+m_c op-ADD n-mcpy://4          |        | FLWR |                                 |        | FLWR |                                 |        | FLWR |                                    |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD | ae+N-4 t-3 i-104 lt-3 e-0 c-104    |        | FLWR |                                 |        | FLWR |                                 |        | FLWR |                                    |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD |                                    |        | FLWR |                                 |        | FLWR |                                 |        | FLWR | N-1+ae t-3 i-104 lt-3 e-0 c-104    | t-3                |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD |                                    |        | FLWR |                                 |        | FLWR |                                 |        | FLWR | N-4+ae_reply ok-False mi-0         |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD | N-4+ae_reply ok-False mi-0         |        | FLWR |                                 |        | FLWR |                                 |        | FLWR |                                    |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD | sn+N-4 i-101                       |        | FLWR |                                 |        | FLWR |                                 |        | FLWR |                                    |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD |                                    |        | FLWR |                                 |        | FLWR |                                 |        | FLWR | N-1+sn i-101                       |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD |                                    |        | FLWR |                                 |        | FLWR |                                 |        | FLWR | snr+N-1 i-101 s-True               |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD | N-4+snr i-101 s-True               |        | FLWR |                                 |        | FLWR |                                 |        | FLWR |                                    |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD | sn+N-4 i-101                       |        | FLWR |                                 |        | FLWR |                                 |        | FLWR |                                    |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD |                                    |        | FLWR |                                 |        | FLWR |                                 |        | FLWR | N-1+sn i-101                       |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD |                                    |        | FLWR |                                 |        | FLWR |                                 |        | FLWR | snr+N-1 i-101 s-True               |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD | N-4+snr i-101 s-True               |        | FLWR |                                 |        | FLWR |                                 |        | FLWR |                                    |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD | sn+N-4 i-101                       |        | FLWR |                                 |        | FLWR |                                 |        | FLWR |                                    |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD |                                    |        | FLWR |                                 |        | FLWR |                                 |        | FLWR | N-1+sn i-101                       |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD |                                    |        | FLWR |                                 |        | FLWR |                                 |        | FLWR | snr+N-1 i-101 s-True               |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD | N-4+snr i-101 s-True               |        | FLWR |                                 |        | FLWR |                                 |        | FLWR |                                    |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD | sn+N-4 i-101                       |        | FLWR |                                 |        | FLWR |                                 |        | FLWR |                                    |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD |                                    |        | FLWR |                                 |        | FLWR |                                 |        | FLWR | N-1+sn i-101                       | ci-101             |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD |                                    |        | FLWR |                                 |        | FLWR |                                 |        | FLWR | snr+N-1 i-101 s-True               |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD | N-4+snr i-101 s-True               |        | FLWR |                                 |        | FLWR |                                 |        | FLWR |                                    |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD | ae+N-4 t-3 i-104 lt-3 e-0 c-104    |        | FLWR |                                 |        | FLWR |                                 |        | FLWR |                                    |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD |                                    |        | FLWR |                                 |        | FLWR |                                 |        | FLWR | N-1+ae t-3 i-104 lt-3 e-0 c-104    |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD |                                    |        | FLWR |                                 |        | FLWR |                                 |        | FLWR | N-4+ae_reply ok-False mi-101       |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD | N-4+ae_reply ok-False mi-101       |        | FLWR |                                 |        | FLWR |                                 |        | FLWR |                                    |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD | ae+N-4 t-3 i-101 lt-1 e-1 c-104    |        | FLWR |                                 |        | FLWR |                                 |        | FLWR |                                    |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD |                                    |        | FLWR |                                 |        | FLWR |                                 |        | FLWR | N-1+ae t-3 i-101 lt-1 e-1 c-104    | lt-2 li-102 ci-102 |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD |                                    |        | FLWR |                                 |        | FLWR |                                 |        | FLWR | N-4+ae_reply ok-True mi-102        |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD | N-4+ae_reply ok-True mi-102        |        | FLWR |                                 |        | FLWR |                                 |        | FLWR |                                    |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD | ae+N-4 t-3 i-102 lt-2 e-2 c-104    |        | FLWR |                                 |        | FLWR |                                 |        | FLWR |                                    |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD |                                    |        | FLWR |                                 |        | FLWR |                                 |        | FLWR | N-1+ae t-3 i-102 lt-2 e-2 c-104    | lt-3 li-104 ci-104 |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD |                                    |        | FLWR |                                 |        | FLWR |                                 |        | FLWR | N-4+ae_reply ok-True mi-104        |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD | N-4+ae_reply ok-True mi-104        | li-105 | FLWR |                                 |        | FLWR |                                 |        | FLWR |                                    |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD | ae+N-2 t-3 i-104 lt-3 e-1 c-104    |        | FLWR |                                 |        | FLWR |                                 |        | FLWR |                                    |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD |                                    |        | FLWR | N-1+ae t-3 i-104 lt-3 e-1 c-104 | li-105 | FLWR |                                 |        | FLWR |                                    |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD |                                    |        | FLWR | N-2+ae_reply ok-True mi-105     |        | FLWR |                                 |        | FLWR |                                    |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD | N-2+ae_reply ok-True mi-105        | ci-105 | FLWR |                                 |        | FLWR |                                 |        | FLWR |                                    |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD | ae+N-3 t-3 i-104 lt-3 e-1 c-104    |        | FLWR |                                 |        | FLWR |                                 |        | FLWR |                                    |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD |                                    |        | FLWR |                                 |        | FLWR | N-1+ae t-3 i-104 lt-3 e-1 c-104 | li-105 | FLWR |                                    |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD |                                    |        | FLWR |                                 |        | FLWR | N-3+ae_reply ok-True mi-105     |        | FLWR |                                    |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD | N-3+ae_reply ok-True mi-105        |        | FLWR |                                 |        | FLWR |                                 |        | FLWR |                                    |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD | m_cr+N-4 op-ADD n-mcpy://4 ok-True |        | FLWR |                                 |        | FLWR |                                 |        | FLWR |                                    |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD |                                    |        | FLWR |                                 |        | FLWR |                                 |        | FLWR | N-1+m_cr op-ADD n-mcpy://4 ok-True |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD | ae+N-4 t-3 i-104 lt-3 e-1 c-104    |        | FLWR |                                 |        | FLWR |                                 |        | FLWR |                                    |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD |                                    |        | FLWR |                                 |        | FLWR |                                 |        | FLWR | N-1+ae t-3 i-104 lt-3 e-1 c-104    | li-105             |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD |                                    |        | FLWR |                                 |        | FLWR |                                 |        | FLWR | N-4+ae_reply ok-True mi-105        |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+
   | LEAD | N-4+ae_reply ok-True mi-105        |        | FLWR |                                 |        | FLWR |                                 |        | FLWR |                                    |                    |
   +------+------------------------------------+--------+------+---------------------------------+--------+------+---------------------------------+--------+------+------------------------------------+--------------------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_snapshots/test_snapshot_3_7.puml
          :scale: 100%


