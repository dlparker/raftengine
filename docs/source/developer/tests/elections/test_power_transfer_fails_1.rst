.. _test_power_transfer_fails_1:

===========================================================
Test test_power_transfer_fails_1 from file test_elections_2
===========================================================


    Tests to see that leader goes back to accepting commands if attempt to
    update power transfer target node does not complete by election_timeout delay.

    We arrange that by crashing the targe node, then running a bunch of commands,
    then recovering the node but before anything else happens start the power transfer
    and then block the messages into the recovered node.

    Timers are disabled, so all timer driven operations such as heartbeats are manually triggered.
  
   

Section 1: Command triggering node one to start election
========================================================




.. collapse:: section 1 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | N-1  | N-1                         | N-1       | N-2  | N-2                         | N-2       | N-3  | N-3                         | N-3       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | Role | Op                          | Delta     | Role | Op                          | Delta     | Role | Op                          | Delta     |
   +======+=============================+===========+======+=============================+===========+======+=============================+===========+
   | CNDI | NEW ROLE                    |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI | poll+N-2 t-1 li-0 lt-1      |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI | poll+N-3 t-1 li-0 lt-1      |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI |                             |           | FLWR | N-1+poll t-1 li-0 lt-1      | t-1       | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI |                             |           | FLWR | vote+N-1 yes-True           |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI |                             |           | FLWR |                             |           | FLWR | N-1+poll t-1 li-0 lt-1      | t-1       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI |                             |           | FLWR |                             |           | FLWR | vote+N-1 yes-True           |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | N-2+vote yes-True           | lt-1 li-1 | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | NEW ROLE                    |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | ae+N-2 t-1 i-0 lt-0 e-1 c-0 |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | ae+N-3 t-1 i-0 lt-0 e-1 c-0 |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | N-3+vote yes-True           |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |                             |           | FLWR | N-1+ae t-1 i-0 lt-0 e-1 c-0 | lt-1 li-1 | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |                             |           | FLWR | N-2+ae_reply ok-True mi-1   |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |                             |           | FLWR |                             |           | FLWR | N-1+ae t-1 i-0 lt-0 e-1 c-0 | lt-1 li-1 |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |                             |           | FLWR |                             |           | FLWR | N-3+ae_reply ok-True mi-1   |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | N-2+ae_reply ok-True mi-1   | ci-1      | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | N-3+ae_reply ok-True mi-1   |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |                             |           | FLWR | CRASH                       |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | CMD START                   |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | ae+N-2 t-1 i-1 lt-1 e-1 c-1 | li-2      | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | ae+N-3 t-1 i-1 lt-1 e-1 c-1 |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |                             |           | FLWR |                             |           | FLWR | N-1+ae t-1 i-1 lt-1 e-1 c-1 | li-2      |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |                             |           | FLWR |                             |           | FLWR | N-3+ae_reply ok-True mi-2   |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | N-3+ae_reply ok-True mi-2   | ci-2      | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | CMD DONE                    |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | CMD START                   |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | ae+N-3 t-1 i-2 lt-1 e-1 c-2 | li-3      | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |                             |           | FLWR |                             |           | FLWR | N-1+ae t-1 i-2 lt-1 e-1 c-2 | li-3      |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |                             |           | FLWR |                             |           | FLWR | N-3+ae_reply ok-True mi-3   |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | N-3+ae_reply ok-True mi-3   | ci-3      | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | CMD DONE                    |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | CMD START                   |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | ae+N-3 t-1 i-3 lt-1 e-1 c-3 | li-4      | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |                             |           | FLWR |                             |           | FLWR | N-1+ae t-1 i-3 lt-1 e-1 c-3 | li-4      |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |                             |           | FLWR |                             |           | FLWR | N-3+ae_reply ok-True mi-4   |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | N-3+ae_reply ok-True mi-4   | ci-4      | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | CMD DONE                    |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_elections_2/test_power_transfer_fails_1_1.puml
          :scale: 100%


Section 2: Buncho commands run, recovering node 2 and blocking it and trying doing power transfer
=================================================================================================




.. collapse:: section 2 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----------------------------+-------+------+---------+-------+------+-----------------------------+-------+
   | N-1  | N-1                         | N-1   | N-2  | N-2     | N-2   | N-3  | N-3                         | N-3   |
   +------+-----------------------------+-------+------+---------+-------+------+-----------------------------+-------+
   | Role | Op                          | Delta | Role | Op      | Delta | Role | Op                          | Delta |
   +======+=============================+=======+======+=========+=======+======+=============================+=======+
   | LEAD |                             |       | FLWR | RESTART |       | FLWR |                             |       |
   +------+-----------------------------+-------+------+---------+-------+------+-----------------------------+-------+
   | LEAD | ae+N-2 t-1 i-4 lt-1 e-0 c-4 |       | FLWR |         |       | FLWR |                             |       |
   +------+-----------------------------+-------+------+---------+-------+------+-----------------------------+-------+
   | LEAD | ae+N-3 t-1 i-4 lt-1 e-0 c-4 |       | FLWR |         |       | FLWR |                             |       |
   +------+-----------------------------+-------+------+---------+-------+------+-----------------------------+-------+
   | LEAD |                             |       | FLWR |         |       | FLWR | N-1+ae t-1 i-4 lt-1 e-0 c-4 | ci-4  |
   +------+-----------------------------+-------+------+---------+-------+------+-----------------------------+-------+
   | LEAD |                             |       | FLWR |         |       | FLWR | N-3+ae_reply ok-True mi-4   |       |
   +------+-----------------------------+-------+------+---------+-------+------+-----------------------------+-------+
   | LEAD | N-3+ae_reply ok-True mi-4   |       | FLWR |         |       | FLWR |                             |       |
   +------+-----------------------------+-------+------+---------+-------+------+-----------------------------+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_elections_2/test_power_transfer_fails_1_2.puml
          :scale: 100%


Section 3: Allowing full election run to complete
=================================================




.. collapse:: section 3 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----------------------------+-------+------+-----+-------+------+-----------------------------+-------+
   | N-1  | N-1                         | N-1   | N-2  | N-2 | N-2   | N-3  | N-3                         | N-3   |
   +------+-----------------------------+-------+------+-----+-------+------+-----------------------------+-------+
   | Role | Op                          | Delta | Role | Op  | Delta | Role | Op                          | Delta |
   +======+=============================+=======+======+=====+=======+======+=============================+=======+
   | LEAD | CMD START                   |       | FLWR |     |       | FLWR |                             |       |
   +------+-----------------------------+-------+------+-----+-------+------+-----------------------------+-------+
   | LEAD | ae+N-3 t-1 i-4 lt-1 e-1 c-4 | li-5  | FLWR |     |       | FLWR |                             |       |
   +------+-----------------------------+-------+------+-----+-------+------+-----------------------------+-------+
   | LEAD |                             |       | FLWR |     |       | FLWR | N-1+ae t-1 i-4 lt-1 e-1 c-4 | li-5  |
   +------+-----------------------------+-------+------+-----+-------+------+-----------------------------+-------+
   | LEAD |                             |       | FLWR |     |       | FLWR | N-3+ae_reply ok-True mi-5   |       |
   +------+-----------------------------+-------+------+-----+-------+------+-----------------------------+-------+
   | LEAD | N-3+ae_reply ok-True mi-5   | ci-5  | FLWR |     |       | FLWR |                             |       |
   +------+-----------------------------+-------+------+-----+-------+------+-----------------------------+-------+
   | LEAD | CMD DONE                    |       | FLWR |     |       | FLWR |                             |       |
   +------+-----------------------------+-------+------+-----+-------+------+-----------------------------+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_elections_2/test_power_transfer_fails_1_3.puml
          :scale: 100%


