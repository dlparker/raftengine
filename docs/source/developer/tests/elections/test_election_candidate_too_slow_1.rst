.. _test_election_candidate_too_slow_1:

==================================================================
Test test_election_candidate_too_slow_1 from file test_elections_2
==================================================================



    This tests the logic when two candidates are active and one of them has a higher term. This
    would normally happen when election timeouts line up just right, but we fiddle the
    log of one of them directly to setup the scenario.

    The test starts with a normal election, then the leader and one other node are pushed
    to candidate. One node gets the term value increased manually.

    Next, the lower term candidate is allowed to send vote requests and the sole follower is
    allowed to receive it an reply. 

    So at this point we have node 3 with term 3 and no vote requests out, node 2 with term 2
    and one yes vote in the input queue, and node 1 having voted for node 2 in term 2.

    Before the node 2 can process the vote, however, the message is intercepted and removed from the input queue.

    Now node 3 (with the higher term) is allowed to send out its request vote messages, and node 2 is allowed
    to receive one.

    This moment is the focus of the test. Node 2 should notice the higher term and resign.

    As a bonus test we push the earlier yes vote from node 1 back on the input queue and allow
    node 2 to process it. It should just ignore it. This is probably notthe only test that hits that code.

    Prevote is disabled for this test as it makes the test code more complicated for no benefit.

    Timers are disabled, so all timer driven operations such as heartbeats are manually triggered.
    

Section 1: Command triggering node three to start election
==========================================================




.. collapse:: section 1 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | N-1  | N-1                         | N-1       | N-2  | N-2                         | N-2       | N-3  | N-3                         | N-3       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | Role | Op                          | Delta     | Role | Op                          | Delta     | Role | Op                          | Delta     |
   +======+=============================+===========+======+=============================+===========+======+=============================+===========+
   | FLWR |                             |           | FLWR |                             |           | CNDI | NEW ROLE                    |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | CNDI | poll+N-1 t-1 li-0 lt-1      |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | CNDI | poll+N-2 t-1 li-0 lt-1      |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR | N-3+poll t-1 li-0 lt-1      | t-1       | FLWR |                             |           | CNDI |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR | vote+N-3 yes-True           |           | FLWR |                             |           | CNDI |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR | N-3+poll t-1 li-0 lt-1      | t-1       | CNDI |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR | vote+N-3 yes-True           |           | CNDI |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | N-1+vote yes-True           | lt-1 li-1 |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | NEW ROLE                    |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | ae+N-1 t-1 i-0 lt-0 e-1 c-0 |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | ae+N-2 t-1 i-0 lt-0 e-1 c-0 |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | N-2+vote yes-True           |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR | N-3+ae t-1 i-0 lt-0 e-1 c-0 | lt-1 li-1 | FLWR |                             |           | LEAD |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR | N-1+ae_reply ok-True mi-1   |           | FLWR |                             |           | LEAD |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR | N-3+ae t-1 i-0 lt-0 e-1 c-0 | lt-1 li-1 | LEAD |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR | N-2+ae_reply ok-True mi-1   |           | LEAD |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | N-1+ae_reply ok-True mi-1   | ci-1      |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | N-2+ae_reply ok-True mi-1   |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_elections_2/test_election_candidate_too_slow_1_1.puml
          :scale: 100%


Section 2: Node 3 is leader, pushing it and node 2 to start elections, but holding messages
===========================================================================================




.. collapse:: section 2 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----+-------+------+----------+-------+------+----------+-------+
   | N-1  | N-1 | N-1   | N-2  | N-2      | N-2   | N-3  | N-3      | N-3   |
   +------+-----+-------+------+----------+-------+------+----------+-------+
   | Role | Op  | Delta | Role | Op       | Delta | Role | Op       | Delta |
   +======+=====+=======+======+==========+=======+======+==========+=======+
   | FLWR |     |       | FLWR |          |       | FLWR | NEW ROLE |       |
   +------+-----+-------+------+----------+-------+------+----------+-------+
   | FLWR |     |       | CNDI | NEW ROLE | t-2   | FLWR |          |       |
   +------+-----+-------+------+----------+-------+------+----------+-------+
   | FLWR |     |       | CNDI |          |       | CNDI | NEW ROLE | t-3   |
   +------+-----+-------+------+----------+-------+------+----------+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_elections_2/test_election_candidate_too_slow_1_2.puml
          :scale: 100%


Section 3: Delivering request votes from node 2 and allowing node 1 to send yes, but holding it in node 2's queue
=================================================================================================================




.. collapse:: section 3 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+------------------------+-------+------+------------------------+-------+------+-----+-------+
   | N-1  | N-1                    | N-1   | N-2  | N-2                    | N-2   | N-3  | N-3 | N-3   |
   +------+------------------------+-------+------+------------------------+-------+------+-----+-------+
   | Role | Op                     | Delta | Role | Op                     | Delta | Role | Op  | Delta |
   +======+========================+=======+======+========================+=======+======+=====+=======+
   | FLWR |                        |       | CNDI | poll+N-1 t-2 li-1 lt-2 |       | CNDI |     |       |
   +------+------------------------+-------+------+------------------------+-------+------+-----+-------+
   | FLWR |                        |       | CNDI | poll+N-3 t-2 li-1 lt-2 |       | CNDI |     |       |
   +------+------------------------+-------+------+------------------------+-------+------+-----+-------+
   | FLWR | N-2+poll t-2 li-1 lt-2 | t-2   | CNDI |                        |       | CNDI |     |       |
   +------+------------------------+-------+------+------------------------+-------+------+-----+-------+
   | FLWR | vote+N-2 yes-True      |       | CNDI |                        |       | CNDI |     |       |
   +------+------------------------+-------+------+------------------------+-------+------+-----+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_elections_2/test_election_candidate_too_slow_1_3.puml
          :scale: 100%


Section 4: Removing node 1's yes vote from queue and allowing node 3 (term 2) to sent request vote messages
===========================================================================================================




.. collapse:: section 4 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----+-------+------+------------------------+-------+------+------------------------+-------+
   | N-1  | N-1 | N-1   | N-2  | N-2                    | N-2   | N-3  | N-3                    | N-3   |
   +------+-----+-------+------+------------------------+-------+------+------------------------+-------+
   | Role | Op  | Delta | Role | Op                     | Delta | Role | Op                     | Delta |
   +======+=====+=======+======+========================+=======+======+========================+=======+
   | FLWR |     |       | CNDI |                        |       | CNDI | poll+N-1 t-3 li-1 lt-3 |       |
   +------+-----+-------+------+------------------------+-------+------+------------------------+-------+
   | FLWR |     |       | CNDI |                        |       | CNDI | poll+N-2 t-3 li-1 lt-3 |       |
   +------+-----+-------+------+------------------------+-------+------+------------------------+-------+
   | FLWR |     |       | FLWR | N-3+poll t-3 li-1 lt-3 | t-3   | CNDI |                        |       |
   +------+-----+-------+------+------------------------+-------+------+------------------------+-------+
   | FLWR |     |       | FLWR | NEW ROLE               |       | CNDI |                        |       |
   +------+-----+-------+------+------------------------+-------+------+------------------------+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_elections_2/test_election_candidate_too_slow_1_4.puml
          :scale: 100%


Section 5: Node 2 has resigned, replacing node 1's yes vote in queue and allowing election to proceed to completion
===================================================================================================================




.. collapse:: section 5 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | N-1  | N-1                         | N-1       | N-2  | N-2                         | N-2       | N-3  | N-3                         | N-3       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | Role | Op                          | Delta     | Role | Op                          | Delta     | Role | Op                          | Delta     |
   +======+=============================+===========+======+=============================+===========+======+=============================+===========+
   | FLWR | N-3+poll t-3 li-1 lt-3      |           | FLWR |                             |           | CNDI |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR | vote+N-3 yes-True           |           | FLWR |                             |           | CNDI |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR | vote+N-3 yes-False          |           | CNDI |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR | N-1+vote yes-True           |           | CNDI |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | CNDI | N-2+poll t-2 li-1 lt-2      |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | CNDI | vote+N-2 yes-False          |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | N-1+vote yes-True           | lt-3 li-2 |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | NEW ROLE                    |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | ae+N-1 t-3 i-1 lt-1 e-1 c-1 |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | ae+N-2 t-3 i-1 lt-1 e-1 c-1 |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | N-2+vote yes-False          |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR | N-3+ae t-3 i-1 lt-1 e-1 c-1 | lt-3 li-2 | FLWR |                             |           | LEAD |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR | N-1+ae_reply ok-True mi-2   |           | FLWR |                             |           | LEAD |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR | N-3+vote yes-False          |           | LEAD |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR | N-3+ae t-3 i-1 lt-1 e-1 c-1 | lt-3 li-2 | LEAD |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR | N-2+ae_reply ok-True mi-2   |           | LEAD |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | N-1+ae_reply ok-True mi-2   | ci-2      |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | N-2+ae_reply ok-True mi-2   |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_elections_2/test_election_candidate_too_slow_1_5.puml
          :scale: 100%


