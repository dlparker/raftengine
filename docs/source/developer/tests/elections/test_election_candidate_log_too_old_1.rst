.. _test_election_candidate_log_too_old_1:

=====================================================================
Test test_election_candidate_log_too_old_1 from file test_elections_2
=====================================================================


    It is possible for a candidate to have a log state that
    is older than the state of other servers during an
    election. The follower election code should detect that and
    vote no on the candidate. This test forces that condition
    by crashing a node, then running a command with the remaining
    nodes, then restarting the crashed node and forcing it to try
    to get elected. This test is identical to test_election_candidate_log_too_old_1
    except that this version uses the pre vote logic.
    
    Timers are disabled, so all timer driven operations such as heartbeats are manually triggered.
    

Section 1: Command triggering node one to start election
========================================================




.. collapse:: section 1 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | N-1  | N-1                         | N-1       | N-2  | N-2                         | N-2       | N-3  | N-3                         | N-3       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | Role | Op                          | Delta     | Role | Op                          | Delta     | Role | Op                          | Delta     |
   +======+=============================+===========+======+=============================+===========+======+=============================+===========+
   | CNDI | NEW ROLE                    |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI | poll+N-2 t-1 li-0 lt-1      |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI | poll+N-3 t-1 li-0 lt-1      |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI |                             |           | FLWR | N-1+poll t-1 li-0 lt-1      | t-1       | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI |                             |           | FLWR | vote+N-1 yes-True           |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI |                             |           | FLWR |                             |           | FLWR | N-1+poll t-1 li-0 lt-1      | t-1       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI |                             |           | FLWR |                             |           | FLWR | vote+N-1 yes-True           |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | N-2+vote yes-True           | lt-1 li-1 | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | NEW ROLE                    |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | ae+N-2 t-1 i-0 lt-0 e-1 c-0 |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | ae+N-3 t-1 i-0 lt-0 e-1 c-0 |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | N-3+vote yes-True           |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |                             |           | FLWR | N-1+ae t-1 i-0 lt-0 e-1 c-0 | lt-1 li-1 | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |                             |           | FLWR | N-2+ae_reply ok-True mi-1   |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |                             |           | FLWR |                             |           | FLWR | N-1+ae t-1 i-0 lt-0 e-1 c-0 | lt-1 li-1 |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |                             |           | FLWR |                             |           | FLWR | N-3+ae_reply ok-True mi-1   |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | N-2+ae_reply ok-True mi-1   | ci-1      | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | N-3+ae_reply ok-True mi-1   |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_elections_2/test_election_candidate_log_too_old_1_1.puml
          :scale: 100%


Section 2: Election done, Node 1 is leader, crashing node 3 and then running a command
======================================================================================




.. collapse:: section 2 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----------------------------+-------+------+-----------------------------+-------+------+-------+-------+
   | N-1  | N-1                         | N-1   | N-2  | N-2                         | N-2   | N-3  | N-3   | N-3   |
   +------+-----------------------------+-------+------+-----------------------------+-------+------+-------+-------+
   | Role | Op                          | Delta | Role | Op                          | Delta | Role | Op    | Delta |
   +======+=============================+=======+======+=============================+=======+======+=======+=======+
   | LEAD |                             |       | FLWR |                             |       | FLWR | CRASH |       |
   +------+-----------------------------+-------+------+-----------------------------+-------+------+-------+-------+
   | LEAD | CMD START                   |       | FLWR |                             |       | FLWR |       |       |
   +------+-----------------------------+-------+------+-----------------------------+-------+------+-------+-------+
   | LEAD | ae+N-2 t-1 i-1 lt-1 e-1 c-1 | li-2  | FLWR |                             |       | FLWR |       |       |
   +------+-----------------------------+-------+------+-----------------------------+-------+------+-------+-------+
   | LEAD | ae+N-3 t-1 i-1 lt-1 e-1 c-1 |       | FLWR |                             |       | FLWR |       |       |
   +------+-----------------------------+-------+------+-----------------------------+-------+------+-------+-------+
   | LEAD |                             |       | FLWR | N-1+ae t-1 i-1 lt-1 e-1 c-1 | li-2  | FLWR |       |       |
   +------+-----------------------------+-------+------+-----------------------------+-------+------+-------+-------+
   | LEAD |                             |       | FLWR | N-2+ae_reply ok-True mi-2   |       | FLWR |       |       |
   +------+-----------------------------+-------+------+-----------------------------+-------+------+-------+-------+
   | LEAD | N-2+ae_reply ok-True mi-2   | ci-2  | FLWR |                             |       | FLWR |       |       |
   +------+-----------------------------+-------+------+-----------------------------+-------+------+-------+-------+
   | LEAD |                             |       | FLWR | N-1+ae t-1 i-2 lt-1 e-0 c-2 | ci-2  | FLWR |       |       |
   +------+-----------------------------+-------+------+-----------------------------+-------+------+-------+-------+
   | LEAD | CMD DONE                    |       | FLWR |                             |       | FLWR |       |       |
   +------+-----------------------------+-------+------+-----------------------------+-------+------+-------+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_elections_2/test_election_candidate_log_too_old_1_2.puml
          :scale: 100%


Section 3: Forcing leader to resign, restarting crashed node and forcing it into election
=========================================================================================




.. collapse:: section 3 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+------------------------+-------+
   | N-1  | N-1                         | N-1       | N-2  | N-2                         | N-2       | N-3  | N-3                    | N-3   |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+------------------------+-------+
   | Role | Op                          | Delta     | Role | Op                          | Delta     | Role | Op                     | Delta |
   +======+=============================+===========+======+=============================+===========+======+========================+=======+
   | FLWR | NEW ROLE                    |           | FLWR |                             |           | FLWR |                        |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+------------------------+-------+
   | FLWR |                             |           | FLWR |                             |           | FLWR | RESTART                |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+------------------------+-------+
   | FLWR |                             |           | FLWR |                             |           | CNDI | NEW ROLE               | t-2   |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+------------------------+-------+
   | FLWR |                             |           | FLWR |                             |           | CNDI | poll+N-1 t-2 li-1 lt-2 |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+------------------------+-------+
   | FLWR |                             |           | FLWR |                             |           | CNDI | poll+N-2 t-2 li-1 lt-2 |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+------------------------+-------+
   | FLWR | N-3+poll t-2 li-1 lt-2      | t-2       | FLWR |                             |           | CNDI |                        |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+------------------------+-------+
   | FLWR | vote+N-3 yes-False          |           | FLWR |                             |           | CNDI |                        |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+------------------------+-------+
   | FLWR |                             |           | FLWR | N-3+poll t-2 li-1 lt-2      | t-2       | CNDI |                        |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+------------------------+-------+
   | FLWR |                             |           | FLWR | N-2+ae_reply ok-True mi-2   |           | CNDI |                        |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+------------------------+-------+
   | FLWR |                             |           | FLWR |                             |           | CNDI | N-1+vote yes-False     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+------------------------+-------+
   | FLWR | N-2+ae_reply ok-True mi-2   |           | FLWR |                             |           | CNDI |                        |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+------------------------+-------+
   | FLWR |                             |           | FLWR | vote+N-3 yes-False          |           | CNDI |                        |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+------------------------+-------+
   | FLWR |                             |           | FLWR |                             |           | CNDI | N-2+vote yes-False     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+------------------------+-------+
   | CNDI | NEW ROLE                    | t-3       | FLWR |                             |           | CNDI |                        |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+------------------------+-------+
   | CNDI | poll+N-2 t-3 li-2 lt-3      |           | FLWR |                             |           | CNDI |                        |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+------------------------+-------+
   | CNDI |                             |           | FLWR | N-1+poll t-3 li-2 lt-3      | t-3       | CNDI |                        |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+------------------------+-------+
   | CNDI |                             |           | FLWR | vote+N-1 yes-True           |           | CNDI |                        |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+------------------------+-------+
   | LEAD | N-2+vote yes-True           | lt-3 li-3 | FLWR |                             |           | CNDI |                        |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+------------------------+-------+
   | LEAD | NEW ROLE                    |           | FLWR |                             |           | CNDI |                        |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+------------------------+-------+
   | LEAD | poll+N-3 t-3 li-2 lt-3      |           | FLWR |                             |           | CNDI |                        |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+------------------------+-------+
   | LEAD |                             |           | FLWR |                             |           | FLWR | N-1+poll t-3 li-2 lt-3 | t-3   |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+------------------------+-------+
   | LEAD |                             |           | FLWR |                             |           | FLWR | NEW ROLE               |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+------------------------+-------+
   | LEAD |                             |           | FLWR |                             |           | FLWR | vote+N-1 yes-False     |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+------------------------+-------+
   | LEAD | N-3+vote yes-False          |           | FLWR |                             |           | FLWR |                        |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+------------------------+-------+
   | LEAD | ae+N-2 t-3 i-2 lt-1 e-1 c-2 |           | FLWR |                             |           | FLWR |                        |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+------------------------+-------+
   | LEAD |                             |           | FLWR | N-1+ae t-3 i-2 lt-1 e-1 c-2 | lt-3 li-3 | FLWR |                        |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+------------------------+-------+
   | LEAD |                             |           | FLWR | N-2+ae_reply ok-True mi-3   |           | FLWR |                        |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+------------------------+-------+
   | LEAD | N-2+ae_reply ok-True mi-3   | ci-3      | FLWR |                             |           | FLWR |                        |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+------------------------+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_elections_2/test_election_candidate_log_too_old_1_3.puml
          :scale: 100%


