.. _test_election_vote_once_1:

=========================================================
Test test_election_vote_once_1 from file test_elections_2
=========================================================


    Tests to make sure that followers only vote once in a single term.

    Test begins with a regular election. Next the leader and one other node are forced
    to start an election.

    The message flow is manipulated to ensure that the only follower node gets a request vote
    from only one candidate, and will vote yes.

    The message flow is again manipulated to allow the follower to get the other vote request,
    and it should reply with a no vote because it has already voted in this term.

    Finally the election is allowed to complete normally.
    
    Prevote is disabled for this test as it makes the test code more complicated for no benefit.
    
    Timers are disabled, so all timer driven operations such as heartbeats are manually triggered.
    

Section 1: Command triggering node three to start election
==========================================================




.. collapse:: section 1 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | N-1  | N-1                         | N-1       | N-2  | N-2                         | N-2       | N-3  | N-3                         | N-3       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | Role | Op                          | Delta     | Role | Op                          | Delta     | Role | Op                          | Delta     |
   +======+=============================+===========+======+=============================+===========+======+=============================+===========+
   | FLWR |                             |           | FLWR |                             |           | CNDI | NEW ROLE                    |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | CNDI | poll+N-1 t-1 li-0 lt-1      |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | CNDI | poll+N-2 t-1 li-0 lt-1      |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR | N-3+poll t-1 li-0 lt-1      | t-1       | FLWR |                             |           | CNDI |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR | vote+N-3 yes-True           |           | FLWR |                             |           | CNDI |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR | N-3+poll t-1 li-0 lt-1      | t-1       | CNDI |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR | vote+N-3 yes-True           |           | CNDI |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | N-1+vote yes-True           | lt-1 li-1 |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | NEW ROLE                    |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | ae+N-1 t-1 i-0 lt-0 e-1 c-0 |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | ae+N-2 t-1 i-0 lt-0 e-1 c-0 |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | N-2+vote yes-True           |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR | N-3+ae t-1 i-0 lt-0 e-1 c-0 | lt-1 li-1 | FLWR |                             |           | LEAD |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR | N-1+ae_reply ok-True mi-1   |           | FLWR |                             |           | LEAD |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR | N-3+ae t-1 i-0 lt-0 e-1 c-0 | lt-1 li-1 | LEAD |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR | N-2+ae_reply ok-True mi-1   |           | LEAD |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | N-1+ae_reply ok-True mi-1   | ci-1      |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | N-2+ae_reply ok-True mi-1   |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_elections_2/test_election_vote_once_1_1.puml
          :scale: 100%


Section 2: Node 3 is leader, forcing it to resign, making it and node 2 start election
======================================================================================




.. collapse:: section 2 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----+-------+------+----------+-------+------+----------+-------+
   | N-1  | N-1 | N-1   | N-2  | N-2      | N-2   | N-3  | N-3      | N-3   |
   +------+-----+-------+------+----------+-------+------+----------+-------+
   | Role | Op  | Delta | Role | Op       | Delta | Role | Op       | Delta |
   +======+=====+=======+======+==========+=======+======+==========+=======+
   | FLWR |     |       | FLWR |          |       | FLWR | NEW ROLE |       |
   +------+-----+-------+------+----------+-------+------+----------+-------+
   | FLWR |     |       | CNDI | NEW ROLE | t-2   | FLWR |          |       |
   +------+-----+-------+------+----------+-------+------+----------+-------+
   | FLWR |     |       | CNDI |          |       | CNDI | NEW ROLE | t-2   |
   +------+-----+-------+------+----------+-------+------+----------+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_elections_2/test_election_vote_once_1_2.puml
          :scale: 100%


Section 3: Letting node 1 get the request vote message from node 2 only, and reply with a yes vote
==================================================================================================




.. collapse:: section 3 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+------------------------+-------+------+------------------------+-----------+------+-----+-------+
   | N-1  | N-1                    | N-1   | N-2  | N-2                    | N-2       | N-3  | N-3 | N-3   |
   +------+------------------------+-------+------+------------------------+-----------+------+-----+-------+
   | Role | Op                     | Delta | Role | Op                     | Delta     | Role | Op  | Delta |
   +======+========================+=======+======+========================+===========+======+=====+=======+
   | FLWR |                        |       | CNDI | poll+N-1 t-2 li-1 lt-2 |           | CNDI |     |       |
   +------+------------------------+-------+------+------------------------+-----------+------+-----+-------+
   | FLWR |                        |       | CNDI | poll+N-3 t-2 li-1 lt-2 |           | CNDI |     |       |
   +------+------------------------+-------+------+------------------------+-----------+------+-----+-------+
   | FLWR | N-2+poll t-2 li-1 lt-2 | t-2   | CNDI |                        |           | CNDI |     |       |
   +------+------------------------+-------+------+------------------------+-----------+------+-----+-------+
   | FLWR | vote+N-2 yes-True      |       | CNDI |                        |           | CNDI |     |       |
   +------+------------------------+-------+------+------------------------+-----------+------+-----+-------+
   | FLWR |                        |       | LEAD | N-1+vote yes-True      | lt-2 li-2 | CNDI |     |       |
   +------+------------------------+-------+------+------------------------+-----------+------+-----+-------+
   | FLWR |                        |       | LEAD | NEW ROLE               |           | CNDI |     |       |
   +------+------------------------+-------+------+------------------------+-----------+------+-----+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_elections_2/test_election_vote_once_1_3.puml
          :scale: 100%


Section 4: Letting node 1 get the request vote message from node 3, which should get a no response
==================================================================================================




.. collapse:: section 4 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+------------------------+-------+------+-----+-------+------+------------------------+-------+
   | N-1  | N-1                    | N-1   | N-2  | N-2 | N-2   | N-3  | N-3                    | N-3   |
   +------+------------------------+-------+------+-----+-------+------+------------------------+-------+
   | Role | Op                     | Delta | Role | Op  | Delta | Role | Op                     | Delta |
   +======+========================+=======+======+=====+=======+======+========================+=======+
   | FLWR |                        |       | LEAD |     |       | CNDI | poll+N-1 t-2 li-1 lt-2 |       |
   +------+------------------------+-------+------+-----+-------+------+------------------------+-------+
   | FLWR |                        |       | LEAD |     |       | CNDI | poll+N-2 t-2 li-1 lt-2 |       |
   +------+------------------------+-------+------+-----+-------+------+------------------------+-------+
   | FLWR | N-3+poll t-2 li-1 lt-2 |       | LEAD |     |       | CNDI |                        |       |
   +------+------------------------+-------+------+-----+-------+------+------------------------+-------+
   | FLWR | vote+N-3 yes-False     |       | LEAD |     |       | CNDI |                        |       |
   +------+------------------------+-------+------+-----+-------+------+------------------------+-------+
   | FLWR |                        |       | LEAD |     |       | CNDI | N-2+poll t-2 li-1 lt-2 |       |
   +------+------------------------+-------+------+-----+-------+------+------------------------+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_elections_2/test_election_vote_once_1_4.puml
          :scale: 100%


Section 5: Allowing full election run to complete
=================================================




.. collapse:: section 5 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | N-1  | N-1                         | N-1       | N-2  | N-2                         | N-2   | N-3  | N-3                         | N-3       |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | Role | Op                          | Delta     | Role | Op                          | Delta | Role | Op                          | Delta     |
   +======+=============================+===========+======+=============================+=======+======+=============================+===========+
   | FLWR |                             |           | LEAD | ae+N-1 t-2 i-1 lt-1 e-1 c-0 |       | CNDI |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD | ae+N-3 t-2 i-1 lt-1 e-1 c-0 |       | CNDI |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD | N-3+poll t-2 li-1 lt-2      |       | CNDI |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD | vote+N-3 yes-False          |       | CNDI |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD |                             |       | CNDI | vote+N-2 yes-False          |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD |                             |       | CNDI | N-1+vote yes-False          |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD |                             |       | FLWR | N-2+ae t-2 i-1 lt-1 e-1 c-0 | lt-2 li-2 |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD |                             |       | FLWR | NEW ROLE                    |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD |                             |       | FLWR | N-3+ae_reply ok-True mi-2   |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD |                             |       | FLWR | N-2+vote yes-False          |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR | N-2+ae t-2 i-1 lt-1 e-1 c-0 | lt-2 li-2 | LEAD |                             |       | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR | N-1+ae_reply ok-True mi-2   |           | LEAD |                             |       | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD | N-3+vote yes-False          |       | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD | N-3+ae_reply ok-True mi-2   | ci-2  | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD | N-1+ae_reply ok-True mi-2   |       | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-------+------+-----------------------------+-----------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_elections_2/test_election_vote_once_1_5.puml
          :scale: 100%


