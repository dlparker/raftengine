@startuml
!pragma ratio 0.7
skinparam dpi 150
skinparam monochrome false
skinparam sequence {
  ArrowColor Black
  ActorBorderColor Black
  LifeLineBorderColor Black
  ParticipantFontSize 12
  Padding 10
}
skinparam legend {
  BackgroundColor #F5F5F5
  FontSize 11
}
title Raft Consensus Sequence (test_reelection_3 Section 2)

participant "Node 1" as n1 order 10 #Lightgreen
participant "Node 2" as n2 order 20 #Lightgreen
participant "Node 3" as n3 order 30 #Lightgreen
n3 -> n3: Becomes CANDIDATE
n1 -> n1: Becomes CANDIDATE
n2 -> n2: Becomes CANDIDATE
n1 -> n2: PreVoteRequest(term=2, lastIndex=1, lastTerm=1)
n2 -> n1: PreVoteRequest(term=2, lastIndex=1, lastTerm=1)
n3 -> n1: PreVoteRequest(term=2, lastIndex=1, lastTerm=1)
n1 -> n3: PreVoteRequest(term=2, lastIndex=1, lastTerm=1)
n2 -> n3: PreVoteRequest(term=2, lastIndex=1, lastTerm=1)
n3 -> n2: PreVoteRequest(term=2, lastIndex=1, lastTerm=1)
n1 -> n2: PreVoteResponse(granted=True)
n2 -> n1: PreVoteResponse(granted=True)
n3 -> n1: PreVoteResponse(granted=True)
note left of n1: Term: 2
n1 -> n3: PreVoteResponse(granted=True)
note right of n2: Term: 2
n2 -> n3: PreVoteResponse(granted=True)
note right of n3: Term: 2
n3 -> n2: PreVoteResponse(granted=True)
n1 -> n2: RequestVote(term=2, lastIndex=1, lastTerm=2)
n2 -> n1: RequestVote(term=2, lastIndex=1, lastTerm=2)
n3 -> n1: RequestVote(term=2, lastIndex=1, lastTerm=2)
n1 -> n3: RequestVote(term=2, lastIndex=1, lastTerm=2)
n2 -> n3: RequestVote(term=2, lastIndex=1, lastTerm=2)
n3 -> n2: RequestVote(term=2, lastIndex=1, lastTerm=2)
n1 -> n2: VoteResponse(granted=False)
n2 -> n1: VoteResponse(granted=False)
n3 -> n1: VoteResponse(granted=False)
n1 -> n3: VoteResponse(granted=False)
n2 -> n3: VoteResponse(granted=False)
n3 -> n2: VoteResponse(granted=False)
n3 -> n1: PreVoteRequest(term=2, lastIndex=1, lastTerm=2)
n1 -> n3: PreVoteResponse(granted=False)
n3 -> n2: PreVoteRequest(term=2, lastIndex=1, lastTerm=2)
n2 -> n3: PreVoteResponse(granted=False)
n2 -> n1: PreVoteRequest(term=3, lastIndex=1, lastTerm=2)
n1 -> n2: PreVoteResponse(granted=True)
note right of n2: Term: 3
n2 -> n3: PreVoteRequest(term=3, lastIndex=1, lastTerm=2)
n3 -> n2: PreVoteResponse(granted=True)
n2 -> n1: RequestVote(term=3, lastIndex=1, lastTerm=3)
note left of n1: Term: 3
n1 -> n1: Becomes FOLLOWER
n1 -> n2: VoteResponse(granted=False)
n2 -> n3: RequestVote(term=3, lastIndex=1, lastTerm=3)
note right of n3: Term: 3
n3 -> n3: Becomes FOLLOWER
n3 -> n2: VoteResponse(granted=True)
note right of n2: Log: index=2, term=3
n2 -> n2: Becomes LEADER
n2 -> n1: AppendEntries(term=3, prevIndex=1, prevTerm=1, 1 entry, commitIndex=0)
note left of n1: Log: index=2, term=3
n1 -> n2: AppendResponse(success=True, maxIndex=2)
note right of n2: Commit: index=2
n2 -> n3: AppendEntries(term=3, prevIndex=1, prevTerm=1, 1 entry, commitIndex=0)
note right of n3: Log: index=2, term=3
n3 -> n2: AppendResponse(success=True, maxIndex=2)

legend right
  <#GhostWhite,#GhostWhite>|      |= __Legend__ |
  |<#Lightgreen>| Raft Node |
  |FOLLOWER| Follower Role |
  |CANDIDATE| Candidate Role |
  |LEADER| Leader Role |
endlegend
@enduml
