.. _test_follower_rewrite_1:

======================================================
Test test_follower_rewrite_1 from file test_commands_1
======================================================


    Tests scenarios where a server becomes leader, then gets disconnected from followers, but not
    yet realizing that it accepts some client command requests, logs them, sends  broadcast to
    try to commit them.

    The while this is going on, the followers hold an election and a new leader is chosen. That
    leader accepts some commands and is able to commit them because it has a quorum, 2 servers,
    in this case, itself and one follower.

    Then the old leader connects to the new leader, and messages  fly to the effect that the
    ex-leader has log records that  match the index of the new leader, but not their term, so those
    records have to be discarded. After that is done the ex-leader  can now catchup, with the help of
    messages from the new leader.

    Sheesh.

    

Section 1: Normal election
==========================




.. collapse:: section 1 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | N-1  | N-1                         | N-1       | N-2  | N-2                         | N-2       | N-3  | N-3                         | N-3       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | Role | Op                          | Delta     | Role | Op                          | Delta     | Role | Op                          | Delta     |
   +======+=============================+===========+======+=============================+===========+======+=============================+===========+
   | CNDI | NEW ROLE                    |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI | p_v_r+N-2 t-1 li-0 lt-0     |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI | p_v_r+N-3 t-1 li-0 lt-0     |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI |                             |           | FLWR | N-1+p_v_r t-1 li-0 lt-0     |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI |                             |           | FLWR | p_v+N-1 yes-True            |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI |                             |           | FLWR |                             |           | FLWR | N-1+p_v_r t-1 li-0 lt-0     |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI |                             |           | FLWR |                             |           | FLWR | p_v+N-1 yes-True            |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI | N-2+p_v yes-True            | t-1       | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI | poll+N-2 t-1 li-0 lt-1      |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI | poll+N-3 t-1 li-0 lt-1      |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI | N-3+p_v yes-True            |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI |                             |           | FLWR | N-1+poll t-1 li-0 lt-1      | t-1       | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI |                             |           | FLWR | vote+N-1 yes-True           |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI |                             |           | FLWR |                             |           | FLWR | N-1+poll t-1 li-0 lt-1      | t-1       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI |                             |           | FLWR |                             |           | FLWR | vote+N-1 yes-True           |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | N-2+vote yes-True           | lt-1 li-1 | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | NEW ROLE                    |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | ae+N-2 t-1 i-0 lt-0 e-1 c-0 |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | ae+N-3 t-1 i-0 lt-0 e-1 c-0 |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | N-3+vote yes-True           |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |                             |           | FLWR | N-1+ae t-1 i-0 lt-0 e-1 c-0 | lt-1 li-1 | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |                             |           | FLWR | N-2+ae_reply ok-True mi-1   |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |                             |           | FLWR |                             |           | FLWR | N-1+ae t-1 i-0 lt-0 e-1 c-0 | lt-1 li-1 |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |                             |           | FLWR |                             |           | FLWR | N-3+ae_reply ok-True mi-1   |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | N-2+ae_reply ok-True mi-1   | ci-1      | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | N-3+ae_reply ok-True mi-1   |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_commands_1/test_follower_rewrite_1_1.puml
          :scale: 100%


Section 2: Node 1 is leader, blocking network traffic to it like a partition and sending two commands
=====================================================================================================




.. collapse:: section 2 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----------+-------+------+-----+-------+------+-----+-------+
   | N-1  | N-1       | N-1   | N-2  | N-2 | N-2   | N-3  | N-3 | N-3   |
   +------+-----------+-------+------+-----+-------+------+-----+-------+
   | Role | Op        | Delta | Role | Op  | Delta | Role | Op  | Delta |
   +======+===========+=======+======+=====+=======+======+=====+=======+
   | LEAD | CMD START |       | FLWR |     |       | FLWR |     |       |
   +------+-----------+-------+------+-----+-------+------+-----+-------+
   | LEAD | CMD DONE  | li-2  | FLWR |     |       | FLWR |     |       |
   +------+-----------+-------+------+-----+-------+------+-----+-------+
   | LEAD | CMD START |       | FLWR |     |       | FLWR |     |       |
   +------+-----------+-------+------+-----+-------+------+-----+-------+
   | LEAD | CMD DONE  | li-3  | FLWR |     |       | FLWR |     |       |
   +------+-----------+-------+------+-----+-------+------+-----+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_commands_1/test_follower_rewrite_1_2.puml
          :scale: 100%


Section 3: Starting election at node 2, which it will win
=========================================================




.. collapse:: section 3 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | N-1  | N-1 | N-1   | N-2  | N-2                         | N-2       | N-3  | N-3                         | N-3       |
   +------+-----+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | Role | Op  | Delta | Role | Op                          | Delta     | Role | Op                          | Delta     |
   +======+=====+=======+======+=============================+===========+======+=============================+===========+
   | LEAD |     |       | CNDI | NEW ROLE                    |           | FLWR |                             |           |
   +------+-----+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |     |       | CNDI | p_v_r+N-1 t-2 li-1 lt-1     |           | FLWR |                             |           |
   +------+-----+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |     |       | CNDI | p_v_r+N-3 t-2 li-1 lt-1     |           | FLWR |                             |           |
   +------+-----+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |     |       | CNDI |                             |           | FLWR | N-2+p_v_r t-2 li-1 lt-1     |           |
   +------+-----+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |     |       | CNDI |                             |           | FLWR | p_v+N-2 yes-True            |           |
   +------+-----+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |     |       | CNDI | N-3+p_v yes-True            | t-2       | FLWR |                             |           |
   +------+-----+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |     |       | CNDI | poll+N-1 t-2 li-1 lt-2      |           | FLWR |                             |           |
   +------+-----+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |     |       | CNDI | poll+N-3 t-2 li-1 lt-2      |           | FLWR |                             |           |
   +------+-----+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |     |       | CNDI |                             |           | FLWR | N-2+poll t-2 li-1 lt-2      | t-2       |
   +------+-----+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |     |       | CNDI |                             |           | FLWR | vote+N-2 yes-True           |           |
   +------+-----+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |     |       | LEAD | N-3+vote yes-True           | lt-2 li-2 | FLWR |                             |           |
   +------+-----+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |     |       | LEAD | NEW ROLE                    |           | FLWR |                             |           |
   +------+-----+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |     |       | LEAD | ae+N-1 t-2 i-1 lt-1 e-1 c-0 |           | FLWR |                             |           |
   +------+-----+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |     |       | LEAD | ae+N-3 t-2 i-1 lt-1 e-1 c-0 |           | FLWR |                             |           |
   +------+-----+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |     |       | LEAD |                             |           | FLWR | N-2+ae t-2 i-1 lt-1 e-1 c-0 | lt-2 li-2 |
   +------+-----+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |     |       | LEAD |                             |           | FLWR | N-3+ae_reply ok-True mi-2   |           |
   +------+-----+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |     |       | LEAD | N-3+ae_reply ok-True mi-2   | ci-2      | FLWR |                             |           |
   +------+-----+-------+------+-----------------------------+-----------+------+-----------------------------+-----------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_commands_1/test_follower_rewrite_1_3.puml
          :scale: 100%


Section 4: Demoting old leader to follower but not reconnecting it yet, running one command at new leader
=========================================================================================================




.. collapse:: section 4 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+----------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | N-1  | N-1      | N-1   | N-2  | N-2                         | N-2   | N-3  | N-3                         | N-3   |
   +------+----------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | Role | Op       | Delta | Role | Op                          | Delta | Role | Op                          | Delta |
   +======+==========+=======+======+=============================+=======+======+=============================+=======+
   | FLWR | NEW ROLE |       | LEAD |                             |       | FLWR |                             |       |
   +------+----------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | FLWR |          |       | LEAD | CMD START                   |       | FLWR |                             |       |
   +------+----------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | FLWR |          |       | LEAD | ae+N-3 t-2 i-2 lt-2 e-1 c-2 | li-3  | FLWR |                             |       |
   +------+----------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | FLWR |          |       | LEAD |                             |       | FLWR | N-2+ae t-2 i-2 lt-2 e-1 c-2 | li-3  |
   +------+----------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | FLWR |          |       | LEAD |                             |       | FLWR | N-3+ae_reply ok-True mi-3   |       |
   +------+----------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | FLWR |          |       | LEAD | N-3+ae_reply ok-True mi-3   | ci-3  | FLWR |                             |       |
   +------+----------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | FLWR |          |       | LEAD |                             |       | FLWR | N-2+ae t-2 i-3 lt-2 e-0 c-3 | ci-3  |
   +------+----------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | FLWR |          |       | LEAD | CMD DONE                    |       | FLWR |                             |       |
   +------+----------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | FLWR |          |       | LEAD |                             |       | FLWR | N-3+ae_reply ok-True mi-3   |       |
   +------+----------+-------+------+-----------------------------+-------+------+-----------------------------+-------+
   | FLWR |          |       | LEAD | N-3+ae_reply ok-True mi-3   |       | FLWR |                             |       |
   +------+----------+-------+------+-----------------------------+-------+------+-----------------------------+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_commands_1/test_follower_rewrite_1_4.puml
          :scale: 100%


Section 5: Reconnecting old leader as follower, now it should have log records that have to be purged, sending heartbeats
=========================================================================================================================




.. collapse:: section 5 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----------------------------+----------------+------+-----------------------------+-------+------+-----------------------------+-------+
   | N-1  | N-1                         | N-1            | N-2  | N-2                         | N-2   | N-3  | N-3                         | N-3   |
   +------+-----------------------------+----------------+------+-----------------------------+-------+------+-----------------------------+-------+
   | Role | Op                          | Delta          | Role | Op                          | Delta | Role | Op                          | Delta |
   +======+=============================+================+======+=============================+=======+======+=============================+=======+
   | FLWR |                             |                | LEAD | ae+N-1 t-2 i-3 lt-2 e-0 c-3 |       | FLWR |                             |       |
   +------+-----------------------------+----------------+------+-----------------------------+-------+------+-----------------------------+-------+
   | FLWR | N-2+ae t-2 i-3 lt-2 e-0 c-3 | t-2            | LEAD |                             |       | FLWR |                             |       |
   +------+-----------------------------+----------------+------+-----------------------------+-------+------+-----------------------------+-------+
   | FLWR | N-1+ae_reply ok-False mi-3  |                | LEAD |                             |       | FLWR |                             |       |
   +------+-----------------------------+----------------+------+-----------------------------+-------+------+-----------------------------+-------+
   | FLWR |                             |                | LEAD | N-1+ae_reply ok-False mi-3  |       | FLWR |                             |       |
   +------+-----------------------------+----------------+------+-----------------------------+-------+------+-----------------------------+-------+
   | FLWR |                             |                | LEAD | ae+N-3 t-2 i-3 lt-2 e-0 c-3 |       | FLWR |                             |       |
   +------+-----------------------------+----------------+------+-----------------------------+-------+------+-----------------------------+-------+
   | FLWR |                             |                | LEAD |                             |       | FLWR | N-2+ae t-2 i-3 lt-2 e-0 c-3 |       |
   +------+-----------------------------+----------------+------+-----------------------------+-------+------+-----------------------------+-------+
   | FLWR |                             |                | LEAD |                             |       | FLWR | N-3+ae_reply ok-True mi-3   |       |
   +------+-----------------------------+----------------+------+-----------------------------+-------+------+-----------------------------+-------+
   | FLWR |                             |                | LEAD | N-3+ae_reply ok-True mi-3   |       | FLWR |                             |       |
   +------+-----------------------------+----------------+------+-----------------------------+-------+------+-----------------------------+-------+
   | FLWR |                             |                | LEAD | ae+N-1 t-2 i-2 lt-2 e-1 c-3 |       | FLWR |                             |       |
   +------+-----------------------------+----------------+------+-----------------------------+-------+------+-----------------------------+-------+
   | FLWR | N-2+ae t-2 i-2 lt-2 e-1 c-3 | li-1           | LEAD |                             |       | FLWR |                             |       |
   +------+-----------------------------+----------------+------+-----------------------------+-------+------+-----------------------------+-------+
   | FLWR | N-1+ae_reply ok-False mi-1  |                | LEAD |                             |       | FLWR |                             |       |
   +------+-----------------------------+----------------+------+-----------------------------+-------+------+-----------------------------+-------+
   | FLWR |                             |                | LEAD | N-1+ae_reply ok-False mi-1  |       | FLWR |                             |       |
   +------+-----------------------------+----------------+------+-----------------------------+-------+------+-----------------------------+-------+
   | FLWR |                             |                | LEAD | ae+N-1 t-2 i-1 lt-1 e-1 c-3 |       | FLWR |                             |       |
   +------+-----------------------------+----------------+------+-----------------------------+-------+------+-----------------------------+-------+
   | FLWR | N-2+ae t-2 i-1 lt-1 e-1 c-3 | lt-2 li-2 ci-2 | LEAD |                             |       | FLWR |                             |       |
   +------+-----------------------------+----------------+------+-----------------------------+-------+------+-----------------------------+-------+
   | FLWR | N-1+ae_reply ok-True mi-2   |                | LEAD |                             |       | FLWR |                             |       |
   +------+-----------------------------+----------------+------+-----------------------------+-------+------+-----------------------------+-------+
   | FLWR |                             |                | LEAD | N-1+ae_reply ok-True mi-2   |       | FLWR |                             |       |
   +------+-----------------------------+----------------+------+-----------------------------+-------+------+-----------------------------+-------+
   | FLWR |                             |                | LEAD | ae+N-1 t-2 i-2 lt-2 e-1 c-3 |       | FLWR |                             |       |
   +------+-----------------------------+----------------+------+-----------------------------+-------+------+-----------------------------+-------+
   | FLWR | N-2+ae t-2 i-2 lt-2 e-1 c-3 | li-3 ci-3      | LEAD |                             |       | FLWR |                             |       |
   +------+-----------------------------+----------------+------+-----------------------------+-------+------+-----------------------------+-------+
   | FLWR | N-1+ae_reply ok-True mi-3   |                | LEAD |                             |       | FLWR |                             |       |
   +------+-----------------------------+----------------+------+-----------------------------+-------+------+-----------------------------+-------+
   | FLWR |                             |                | LEAD | N-1+ae_reply ok-True mi-3   |       | FLWR |                             |       |
   +------+-----------------------------+----------------+------+-----------------------------+-------+------+-----------------------------+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_commands_1/test_follower_rewrite_1_5.puml
          :scale: 100%


