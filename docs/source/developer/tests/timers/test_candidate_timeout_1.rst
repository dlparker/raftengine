.. _test_candidate_timeout_1:

=====================================================
Test test_candidate_timeout_1 from file test_timers_1
=====================================================


    Test to ensure that a candidate will give up on campaign if no resolution happens
    by election timeout time, and then start a new election. This is with pre vote disabled.

    Test begins with a normal election with test-like timer values but timers disabled.

    Then node1 and node3 have their networks switch to blocked mode so they won't process
    any messages. Node 1, the leader is also forced to retire. So now there are two
    followers but node 2 can't reach them.

    Next auto transport is enabled and node2 has its timers enabled. Things are allowed
    to run long enough that node 2 should timeout and try again. The value of
    node2 term will indicate when that has happend.

    When that works, the other nodes are unblocked and the election is allowed to proceed.
    
    

Section 1: Normal election
==========================




.. collapse:: section 1 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | N-1  | N-1                         | N-1       | N-2  | N-2                         | N-2       | N-3  | N-3                         | N-3       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | Role | Op                          | Delta     | Role | Op                          | Delta     | Role | Op                          | Delta     |
   +======+=============================+===========+======+=============================+===========+======+=============================+===========+
   | CNDI | NEW ROLE                    |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI | poll+N-2 t-1 li-0 lt-1      |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI | poll+N-3 t-1 li-0 lt-1      |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI |                             |           | FLWR | N-1+poll t-1 li-0 lt-1      | t-1       | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI |                             |           | FLWR | vote+N-1 yes-True           |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI |                             |           | FLWR |                             |           | FLWR | N-1+poll t-1 li-0 lt-1      | t-1       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | CNDI |                             |           | FLWR |                             |           | FLWR | vote+N-1 yes-True           |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | N-2+vote yes-True           | lt-1 li-1 | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | NEW ROLE                    |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | ae+N-2 t-1 i-0 lt-0 e-1 c-0 |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | ae+N-3 t-1 i-0 lt-0 e-1 c-0 |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | N-3+vote yes-True           |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |                             |           | FLWR | N-1+ae t-1 i-0 lt-0 e-1 c-0 | lt-1 li-1 | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |                             |           | FLWR | N-2+ae_reply ok-True mi-1   |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |                             |           | FLWR |                             |           | FLWR | N-1+ae t-1 i-0 lt-0 e-1 c-0 | lt-1 li-1 |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD |                             |           | FLWR |                             |           | FLWR | N-3+ae_reply ok-True mi-1   |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | N-2+ae_reply ok-True mi-1   | ci-1      | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | LEAD | N-3+ae_reply ok-True mi-1   |           | FLWR |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_timers_1/test_candidate_timeout_1_1.puml
          :scale: 100%


Section 3: Starting auto comms, enabling timers at node 2 and it to start election
==================================================================================




.. collapse:: section 3 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----+-------+------+------------------------+-------+------+-----+-------+
   | N-1  | N-1 | N-1   | N-2  | N-2                    | N-2   | N-3  | N-3 | N-3   |
   +------+-----+-------+------+------------------------+-------+------+-----+-------+
   | Role | Op  | Delta | Role | Op                     | Delta | Role | Op  | Delta |
   +======+=====+=======+======+========================+=======+======+=====+=======+
   | FLWR |     |       | CNDI | poll+N-1 t-2 li-1 lt-2 |       | FLWR |     |       |
   +------+-----+-------+------+------------------------+-------+------+-----+-------+
   | FLWR |     |       | CNDI | poll+N-3 t-2 li-1 lt-2 |       | FLWR |     |       |
   +------+-----+-------+------+------------------------+-------+------+-----+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_timers_1/test_candidate_timeout_1_3.puml
          :scale: 100%


Section 4: Node 2 started election, waiting for it to timeout
=============================================================




.. collapse:: section 4 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----+-------+------+-----+-------+------+-----+-------+
   | N-1  | N-1 | N-1   | N-2  | N-2 | N-2   | N-3  | N-3 | N-3   |
   +------+-----+-------+------+-----+-------+------+-----+-------+
   | Role | Op  | Delta | Role | Op  | Delta | Role | Op  | Delta |
   +------+-----+-------+------+-----+-------+------+-----+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_timers_1/test_candidate_timeout_1_4.puml
          :scale: 100%


Section 5: Node 2 election timeout detected, enabling other nodes to let election finish
========================================================================================




.. collapse:: section 5 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | N-1  | N-1                         | N-1       | N-2  | N-2                         | N-2       | N-3  | N-3                         | N-3       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | Role | Op                          | Delta     | Role | Op                          | Delta     | Role | Op                          | Delta     |
   +======+=============================+===========+======+=============================+===========+======+=============================+===========+
   | FLWR |                             |           | CNDI | poll+N-1 t-3 li-1 lt-3      |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR | N-2+poll t-3 li-1 lt-3      | t-3       | CNDI |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR | vote+N-2 yes-True           |           | CNDI |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD | N-1+vote yes-True           | lt-3 li-2 | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD | NEW ROLE                    |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD | poll+N-3 t-3 li-1 lt-3      |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD |                             |           | FLWR | N-2+poll t-3 li-1 lt-3      | t-3       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD |                             |           | FLWR | vote+N-2 yes-True           |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD | N-3+vote yes-True           |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD | ae+N-1 t-3 i-1 lt-1 e-1 c-0 |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR | N-2+ae t-3 i-1 lt-1 e-1 c-0 | lt-3 li-2 | LEAD |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR | N-1+ae_reply ok-True mi-2   |           | LEAD |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD | N-1+ae_reply ok-True mi-2   | ci-2      | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD | ae+N-3 t-3 i-1 lt-1 e-1 c-0 |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD |                             |           | FLWR | N-2+ae t-3 i-1 lt-1 e-1 c-0 | lt-3 li-2 |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD |                             |           | FLWR | N-3+ae_reply ok-True mi-2   |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD | N-3+ae_reply ok-True mi-2   |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD | ae+N-1 t-3 i-2 lt-3 e-0 c-2 |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR | N-2+ae t-3 i-2 lt-3 e-0 c-2 | ci-2      | LEAD |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR | N-1+ae_reply ok-True mi-2   |           | LEAD |                             |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD | N-1+ae_reply ok-True mi-2   |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD | ae+N-3 t-3 i-2 lt-3 e-0 c-2 |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD |                             |           | FLWR | N-2+ae t-3 i-2 lt-3 e-0 c-2 | ci-2      |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD |                             |           | FLWR | N-3+ae_reply ok-True mi-2   |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | LEAD | N-3+ae_reply ok-True mi-2   |           | FLWR |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_timers_1/test_candidate_timeout_1_5.puml
          :scale: 100%


