.. _test_slow_voter:

=============================================
Test test_slow_voter from file test_msg_edges
=============================================


    This tests the rare case where a candidate starts a new election, sends requests, then for some
    reason starts another election at a higher term and then receives a vote reponse from the previous term.
    This seems pretty unlikely in practice, but not impossible, so there is code for it. About three lines.
    All this test does is poke those lines.

    It goes like this:

    1. Normal election
    2. The leader (node 3) is forced to start a new election.
    3. Messages are managed such that the followers get the requests for vote and send replies,
       but everything stops before the candidate gets their responses.
    4. The candidate starts a new election, so term is now 3
    5. The messages are processed enough to see that the candidate gets the stale once, and
       then the new voting cycle works and yes votes for the new term arrive.
    6. The rest of the messages are delivered to complete the election

    The test is run with pre_vote disabled. The relavant part is when the actual votes happen,
    and the test would be much more complicated if we had to handle pre vote messages too.
    
    Timers are disabled, so all timer driven operations such as heartbeats are manually triggered.
    

Section 1: Normal election
==========================




.. collapse:: section 1 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | N-1  | N-1                         | N-1       | N-2  | N-2                         | N-2       | N-3  | N-3                         | N-3       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | Role | Op                          | Delta     | Role | Op                          | Delta     | Role | Op                          | Delta     |
   +======+=============================+===========+======+=============================+===========+======+=============================+===========+
   | FLWR |                             |           | FLWR |                             |           | CNDI | NEW ROLE                    |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | CNDI | poll+N-1 t-1 li-0 lt-1      |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | CNDI | poll+N-2 t-1 li-0 lt-1      |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR | N-3+poll t-1 li-0 lt-1      | t-1       | FLWR |                             |           | CNDI |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR | vote+N-3 yes-True           |           | FLWR |                             |           | CNDI |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR | N-3+poll t-1 li-0 lt-1      | t-1       | CNDI |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR | vote+N-3 yes-True           |           | CNDI |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | N-1+vote yes-True           | lt-1 li-1 |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | NEW ROLE                    |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | ae+N-1 t-1 i-0 lt-0 e-1 c-0 |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | ae+N-2 t-1 i-0 lt-0 e-1 c-0 |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | N-2+vote yes-True           |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR | N-3+ae t-1 i-0 lt-0 e-1 c-0 | lt-1 li-1 | FLWR |                             |           | LEAD |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR | N-1+ae_reply ok-True mi-1   |           | FLWR |                             |           | LEAD |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR | N-3+ae t-1 i-0 lt-0 e-1 c-0 | lt-1 li-1 | LEAD |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR | N-2+ae_reply ok-True mi-1   |           | LEAD |                             |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | N-1+ae_reply ok-True mi-1   | ci-1      |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | N-2+ae_reply ok-True mi-1   |           |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-----------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_msg_edges/test_slow_voter_1.puml
          :scale: 100%


Section 2: Node 3 is leader, demoting and ensuring vote requests are delivered, but responses not accepted yet
==============================================================================================================




.. collapse:: section 2 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+------------------------+-------+------+------------------------+-------+------+------------------------+-------+
   | N-1  | N-1                    | N-1   | N-2  | N-2                    | N-2   | N-3  | N-3                    | N-3   |
   +------+------------------------+-------+------+------------------------+-------+------+------------------------+-------+
   | Role | Op                     | Delta | Role | Op                     | Delta | Role | Op                     | Delta |
   +======+========================+=======+======+========================+=======+======+========================+=======+
   | FLWR |                        |       | FLWR |                        |       | FLWR | NEW ROLE               |       |
   +------+------------------------+-------+------+------------------------+-------+------+------------------------+-------+
   | FLWR |                        |       | FLWR |                        |       | CNDI | NEW ROLE               | t-2   |
   +------+------------------------+-------+------+------------------------+-------+------+------------------------+-------+
   | FLWR |                        |       | FLWR |                        |       | CNDI | poll+N-1 t-2 li-1 lt-2 |       |
   +------+------------------------+-------+------+------------------------+-------+------+------------------------+-------+
   | FLWR |                        |       | FLWR |                        |       | CNDI | poll+N-2 t-2 li-1 lt-2 |       |
   +------+------------------------+-------+------+------------------------+-------+------+------------------------+-------+
   | FLWR | N-3+poll t-2 li-1 lt-2 | t-2   | FLWR |                        |       | CNDI |                        |       |
   +------+------------------------+-------+------+------------------------+-------+------+------------------------+-------+
   | FLWR |                        |       | FLWR | N-3+poll t-2 li-1 lt-2 | t-2   | CNDI |                        |       |
   +------+------------------------+-------+------+------------------------+-------+------+------------------------+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_msg_edges/test_slow_voter_2.puml
          :scale: 100%


Section 3: Starting another election at node 3, whose term is now 3 and checking that pending messages are stale
================================================================================================================




.. collapse:: section 3 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-------------------+-------+------+-------------------+-------+------+-------------------+-------+
   | N-1  | N-1               | N-1   | N-2  | N-2               | N-2   | N-3  | N-3               | N-3   |
   +------+-------------------+-------+------+-------------------+-------+------+-------------------+-------+
   | Role | Op                | Delta | Role | Op                | Delta | Role | Op                | Delta |
   +======+===================+=======+======+===================+=======+======+===================+=======+
   | FLWR |                   |       | FLWR |                   |       | CNDI | NEW ROLE          |       |
   +------+-------------------+-------+------+-------------------+-------+------+-------------------+-------+
   | FLWR | vote+N-3 yes-True |       | FLWR |                   |       | CNDI |                   |       |
   +------+-------------------+-------+------+-------------------+-------+------+-------------------+-------+
   | FLWR |                   |       | FLWR |                   |       | CNDI | N-1+vote yes-True |       |
   +------+-------------------+-------+------+-------------------+-------+------+-------------------+-------+
   | FLWR |                   |       | FLWR | vote+N-3 yes-True |       | CNDI |                   |       |
   +------+-------------------+-------+------+-------------------+-------+------+-------------------+-------+
   | FLWR |                   |       | FLWR |                   |       | CNDI | N-2+vote yes-True |       |
   +------+-------------------+-------+------+-------------------+-------+------+-------------------+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_msg_edges/test_slow_voter_3.puml
          :scale: 100%


Section 4: Allowing some messages for second election, checking that term is correct
====================================================================================




.. collapse:: section 4 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+------------------------+-------+------+------------------------+-------+------+------------------------+-------+
   | N-1  | N-1                    | N-1   | N-2  | N-2                    | N-2   | N-3  | N-3                    | N-3   |
   +------+------------------------+-------+------+------------------------+-------+------+------------------------+-------+
   | Role | Op                     | Delta | Role | Op                     | Delta | Role | Op                     | Delta |
   +======+========================+=======+======+========================+=======+======+========================+=======+
   | FLWR |                        |       | FLWR |                        |       | CNDI | poll+N-1 t-3 li-1 lt-3 |       |
   +------+------------------------+-------+------+------------------------+-------+------+------------------------+-------+
   | FLWR |                        |       | FLWR |                        |       | CNDI | poll+N-2 t-3 li-1 lt-3 |       |
   +------+------------------------+-------+------+------------------------+-------+------+------------------------+-------+
   | FLWR |                        |       | FLWR | N-3+poll t-3 li-1 lt-3 | t-3   | CNDI |                        |       |
   +------+------------------------+-------+------+------------------------+-------+------+------------------------+-------+
   | FLWR |                        |       | FLWR | vote+N-3 yes-True      |       | CNDI |                        |       |
   +------+------------------------+-------+------+------------------------+-------+------+------------------------+-------+
   | FLWR | N-3+poll t-3 li-1 lt-3 | t-3   | FLWR |                        |       | CNDI |                        |       |
   +------+------------------------+-------+------+------------------------+-------+------+------------------------+-------+
   | FLWR | vote+N-3 yes-True      |       | FLWR |                        |       | CNDI |                        |       |
   +------+------------------------+-------+------+------------------------+-------+------+------------------------+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_msg_edges/test_slow_voter_4.puml
          :scale: 100%


Section 5: Allowing remainging messages for normal election to complete
=======================================================================




.. collapse:: section 5 trace table (click to toggle view)

   - See :ref:`Trace Table Legend` for help interpreting table contents

   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-------+
   | N-1  | N-1                         | N-1       | N-2  | N-2                         | N-2       | N-3  | N-3                         | N-3   |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-------+
   | Role | Op                          | Delta     | Role | Op                          | Delta     | Role | Op                          | Delta |
   +======+=============================+===========+======+=============================+===========+======+=============================+=======+
   | FLWR |                             |           | FLWR |                             |           | LEAD | N-2+vote yes-True           |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | NEW ROLE                    |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | ae+N-1 t-3 i-1 lt-1 e-1 c-1 |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-------+
   | FLWR | N-3+ae t-3 i-1 lt-1 e-1 c-1 | lt-3 li-2 | FLWR |                             |           | LEAD |                             |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-------+
   | FLWR | N-1+ae_reply ok-True mi-2   |           | FLWR |                             |           | LEAD |                             |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | N-1+vote yes-True           |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | ae+N-2 t-3 i-1 lt-1 e-1 c-1 |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-------+
   | FLWR |                             |           | FLWR | N-3+ae t-3 i-1 lt-1 e-1 c-1 | lt-3 li-2 | LEAD |                             |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-------+
   | FLWR |                             |           | FLWR | N-2+ae_reply ok-True mi-2   |           | LEAD |                             |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | N-1+ae_reply ok-True mi-2   | ci-2  |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-------+
   | FLWR |                             |           | FLWR |                             |           | LEAD | N-2+ae_reply ok-True mi-2   |       |
   +------+-----------------------------+-----------+------+-----------------------------+-----------+------+-----------------------------+-------+



.. collapse:: trace sequence diagram (click to toggle view)

   .. plantuml:: /developer/tests/diagrams/test_msg_edges/test_slow_voter_5.puml
          :scale: 100%


